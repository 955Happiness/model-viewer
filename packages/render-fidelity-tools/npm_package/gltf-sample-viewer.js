"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("gl-matrix"),t=require("jpeg-js"),i=require("fast-png");function r(t){let i=new e.glMatrix.ARRAY_TYPE(t.length);for(let e=0;e<t.length;++e)i[e]=t[e];return i}function s(t,i,r){let s=new e.glMatrix.ARRAY_TYPE(r);for(let e=0;e<r;++e)s[e]=t[i+e];return s}function n(e,t,i){for(const r of Object.keys(e)){const s=e[r];if(void 0!==s&&(void 0!==s.initGl&&s.initGl(t,i),Array.isArray(s)))for(const e of s)null!=e&&void 0!==e.initGl&&e.initGl(t,i)}}function o(e,t){if(void 0===e)return[];const i=[];for(const r of e)i.push(a(r,t));return i}function a(e,t){const i=new t;return i.fromJson(e),i}function l(e,t,i=[]){for(let r of Object.keys(e))if((!i||void 0===i.find((function(e){return e==r})))&&void 0!==t[r]){e[r.replace("^@","")]=t[r]}}function c(e,t=0){for(var i=0;i<e.length;++i)t=Math.imul(31,t)+e.charCodeAt(i)|0;return t}function u(e,t,i){return Math.min(Math.max(e,t),i)}function f(e){return"glb"==h(e)}function h(e){const t=e.toLowerCase().split(".");if(1!=t.length)return t[t.length-1]}function d(e){return e.substring(0,e.lastIndexOf("/")+1)}class m{}class p{constructor(){this.startTime=0,this.paused=!0,this.fixedTime=null,this.pausedTime=0}elapsedSec(){return this.paused?this.pausedTime/1e3:this.fixedTime||((new Date).getTime()-this.startTime)/1e3}toggle(){this.paused?this.unpause():this.pause()}start(){this.startTime=(new Date).getTime(),this.paused=!1}pause(){this.pausedTime=(new Date).getTime()-this.startTime,this.paused=!0}unpause(){this.startTime+=(new Date).getTime()-this.startTime-this.pausedTime,this.paused=!1}reset(){this.paused?this.startTime=0:this.startTime=(new Date).getTime(),this.pausedTime=0}setFixedTime(e){this.paused=!1,this.fixedTime=e}}class g{constructor(){this.extensions=void 0,this.extras=void 0}fromJson(e){l(this,e)}initGl(e,t){n(this,e,t)}}class _ extends g{constructor(e="perspective",t=.01,i=1e4,r=45*Math.PI/180,s=16/9,n=1,o=1,a,l){super(),this.type=e,this.znear=t,this.zfar=i,this.yfov=r,this.xmag=n,this.ymag=o,this.aspectRatio=s,this.name=a,this.node=l}initGl(e,t){let i;super.initGl(e,t);for(let t=0;t<e.nodes.length;t++)if(i=e.nodes[t].camera,void 0!==i&&e.cameras[i]===this){this.node=t;break}void 0===this.node&&void 0!==i&&console.error("Invalid node for camera "+i)}fromJson(e){this.name=name,void 0!==e.perspective?(this.type="perspective",l(this,e.perspective)):void 0!==e.orthographic&&(this.type="orthographic",l(this,e.orthographic))}sortPrimitivesByDepth(t,i){for(const r of i){const i=e.mat4.create();e.mat4.multiply(i,this.getViewMatrix(t),r.node.worldTransform);const s=e.vec3.transformMat4(e.vec3.create(),e.vec3.clone(r.primitive.centroid),i);r.depth=s[2]}return i.filter((e=>e.depth<=0)).sort(((e,t)=>e.depth-t.depth))}getProjectionMatrix(){const t=e.mat4.create();return"perspective"===this.type?e.mat4.perspective(t,this.yfov,this.aspectRatio,this.znear,this.zfar):"orthographic"===this.type&&(t[0]=1/this.xmag,t[5]=1/this.ymag,t[10]=2/(this.znear-this.zfar),t[14]=(this.zfar+this.znear)/(this.znear-this.zfar)),t}getViewMatrix(t){const i=e.mat4.create(),r=this.getPosition(t),s=this.getLookAtTarget(t);return e.mat4.lookAt(i,r,s,e.vec3.fromValues(0,1,0)),i}getLookAtTarget(t){const i=e.vec3.create(),r=this.getPosition(t),s=this.getLookDirection(t);return e.vec3.add(i,s,r),i}getPosition(t){const i=e.vec3.create(),r=this.getNode(t);return e.mat4.getTranslation(i,r.worldTransform),i}getLookDirection(t){const i=e.vec3.create(),r=this.getRotation(t);return e.vec3.transformQuat(i,e.vec3.fromValues(0,0,-1),r),i}getRotation(t){const i=e.quat.create(),r=this.getNode(t);return e.mat4.getRotation(i,r.worldTransform),i}clone(){return new _(this.type,this.znear,this.zfar,this.yfov,this.aspectRatio,this.xmag,this.ymag,this.name,this.node)}getNode(e){return e.nodes[this.node]}}function T(t,i,s,n){const o=e.vec3.create();e.vec3.transformMat4(o,r(t.min),i);const a=e.vec3.create();e.vec3.transformMat4(a,r(t.max),i);const l=e.vec3.create();e.vec3.add(l,a,o),e.vec3.scale(l,l,.5);const c=e.vec3.create();e.vec3.sub(c,a,l);const u=e.vec3.length(c);for(const e of[0,1,2])s[e]=l[e]-u,n[e]=l[e]+u}const v=e.vec3.create();class E extends _{constructor(t=[0,0,0],i=[0,0,0],s=[0,1,0],n=0,o=0,a=1){super(),this.position=r(t),this.target=r(i),this.up=r(s),this.xRot=n,this.yRot=o,this.zoom=a,this.zoomFactor=1.04,this.rotateSpeed=1/180,this.panSpeed=1,this.sceneExtents={min:e.vec3.create(),max:e.vec3.create()}}updatePosition(){const t=e.vec3.fromValues(0,0,1);this.toLocalRotation(t);const i=e.vec3.create();e.vec3.scale(i,t,this.zoom),e.vec3.add(i,i,this.target),this.position=i,this.fitCameraPlanesToExtents(this.sceneExtents.min,this.sceneExtents.max)}reset(e,t){this.xRot=0,this.yRot=0,this.fitViewToScene(e,t,!0)}zoomIn(e){e>0?this.zoom*=this.zoomFactor:this.zoom/=this.zoomFactor}rotate(e,t){const i=Math.PI/2-.01;this.xRot+=e*this.rotateSpeed,this.yRot+=t*this.rotateSpeed,this.yRot=u(this.yRot,-i,i)}pan(t,i){const r=e.vec3.fromValues(-1,0,0);this.toLocalRotation(r),e.vec3.scale(r,r,t*this.panSpeed);const s=e.vec3.fromValues(0,1,0);this.toLocalRotation(s),e.vec3.scale(s,s,i*this.panSpeed),e.vec3.add(this.target,this.target,s),e.vec3.add(this.target,this.target,r)}fitPanSpeedToScene(t,i){const r=e.vec3.distance(t,i);this.panSpeed=r/1200}fitViewToScene(t,i){!function(t,i,r,s){for(const e of[0,1,2])r[e]=Number.POSITIVE_INFINITY,s[e]=Number.NEGATIVE_INFINITY;let n=t.scenes[i].nodes.slice();for(;n.length>0;){const i=t.nodes[n.pop()];if(n=n.concat(i.children),void 0===i.mesh)continue;const o=t.meshes[i.mesh];if(void 0!==o.primitives)for(const n of o.primitives){const o=n.glAttributes.find((e=>"POSITION"==e.attribute));if(void 0===o)continue;const a=t.accessors[o.accessor],l=e.vec3.create(),c=e.vec3.create();T(a,i.worldTransform,l,c);for(const e of[0,1,2])r[e]=Math.min(r[e],l[e]),s[e]=Math.max(s[e],c[e])}}}(t,i,this.sceneExtents.min,this.sceneExtents.max),this.fitCameraTargetToExtents(this.sceneExtents.min,this.sceneExtents.max),this.fitZoomToExtents(this.sceneExtents.min,this.sceneExtents.max),this.fitPanSpeedToScene(this.sceneExtents.min,this.sceneExtents.max),this.fitCameraPlanesToExtents(this.sceneExtents.min,this.sceneExtents.max)}toLocalRotation(t){e.vec3.rotateX(t,t,v,-this.yRot),e.vec3.rotateY(t,t,v,-this.xRot)}getLookAtTarget(){return this.target}getPosition(){return this.position}fitZoomToExtents(e,t){const i=Math.max(t[0]-e[0],t[1]-e[1]);this.zoom=this.getFittingZoom(i)}fitCameraTargetToExtents(e,t){for(const i of[0,1,2])this.target[i]=(t[i]+e[i])/2}fitCameraPlanesToExtents(t,i){const r=10*e.vec3.distance(t,i);let s=this.zoom-.6*r,n=this.zoom+.6*r;s=Math.max(s,n/1e4),this.znear=s,this.zfar=n}getFittingZoom(e){const t=this.yfov,i=this.yfov*this.aspectRatio,r=e/2/Math.tan(t/2),s=e/2/Math.tan(i/2);return Math.max(s,r)}}function A(e){return e&&0==(e&e-1)}class x{static async readAsArrayBuffer(e){return new Promise(((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=i,r.readAsArrayBuffer(e)}))}static async readAsText(e){return new Promise(((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=i,r.readAsText(e)}))}static async readAsDataURL(e){return new Promise(((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=i,r.readAsDataURL(e)}))}}const S="image/jpeg",R="image/png",b="image/ktx2",C="image/texture";let N;class I{constructor(e){this.context=e,void 0===N&&(N=e)}loadWebGlExtensions(e){for(let t of e)null===this.context.getExtension(t)&&console.warn("Extension "+t+" not supported!")}setTexture(e,t,i,r){if(-1===e)return!1;let s=t.textures[i.index];if(void 0===s)return console.warn("Texture is undefined: "+i.index),!1;const n=t.images[s.source];if(n.mimeType!==b&&n.mimeType!==C||(s.glTexture=n.image,s.initialized=!0),void 0===s.glTexture&&(s.glTexture=this.context.createTexture()),this.context.activeTexture(N.TEXTURE0+r),this.context.bindTexture(s.type,s.glTexture),this.context.uniform1i(e,r),!s.initialized){const e=t.samplers[s.sampler];if(void 0===e)return console.warn("Sampler is undefined for texture: "+i.index),!1;if(this.context.pixelStorei(N.UNPACK_FLIP_Y_WEBGL,!1),void 0===n)return console.warn("Image is undefined for texture: "+s.source),!1;const r=i.linear?N.RGBA:N.SRGB8_ALPHA8;this.context.texImage2D(n.type,n.miplevel,r,N.RGBA,N.UNSIGNED_BYTE,n.image);const o=n.shouldGenerateMips();if(this.setSampler(e,s.type,o),i.generateMips&&o)switch(e.minFilter){case N.NEAREST_MIPMAP_NEAREST:case N.NEAREST_MIPMAP_LINEAR:case N.LINEAR_MIPMAP_NEAREST:case N.LINEAR_MIPMAP_LINEAR:this.context.generateMipmap(s.type)}s.initialized=!0}return s.initialized}setIndices(e,t){let i=e.accessors[t];if(void 0===i.glBuffer){i.glBuffer=this.context.createBuffer();let t=i.getTypedView(e);if(void 0===t)return!1;this.context.bindBuffer(N.ELEMENT_ARRAY_BUFFER,i.glBuffer),this.context.bufferData(N.ELEMENT_ARRAY_BUFFER,t,N.STATIC_DRAW)}else this.context.bindBuffer(N.ELEMENT_ARRAY_BUFFER,i.glBuffer);return!0}enableAttribute(e,t,i){if(-1===t)return console.warn("Tried to access unknown attribute"),!1;if(void 0===i.bufferView)return console.warn("Tried to access undefined bufferview"),!0;let r=e.bufferViews[i.bufferView];if(void 0===i.glBuffer){i.glBuffer=this.context.createBuffer();let t=i.getTypedView(e);if(void 0===t)return!1;this.context.bindBuffer(N.ARRAY_BUFFER,i.glBuffer),this.context.bufferData(N.ARRAY_BUFFER,t,N.STATIC_DRAW)}else this.context.bindBuffer(N.ARRAY_BUFFER,i.glBuffer);return this.context.vertexAttribPointer(t,i.getComponentCount(i.type),i.componentType,i.normalized,r.byteStride,0),this.context.enableVertexAttribArray(t),!0}compileShader(e,t,i){const r=this.context.createShader(t?N.VERTEX_SHADER:N.FRAGMENT_SHADER);this.context.shaderSource(r,i),this.context.compileShader(r);if(!this.context.getShaderParameter(r,N.COMPILE_STATUS)){let t="";const s=this.context.getShaderInfoLog(r).split("\n");for(const e of s){t+=e+"\n";const r=e.match(/(?:(?:WARNING)|(?:ERROR)): [0-9]*:([0-9]*).*/i);if(r&&r.length>1){const e=parseInt(r[1])-1,s=i.split("\n");for(let i=Math.max(0,e-2);i<Math.min(s.length,e+3);i++)e===i&&(t+="->"),t+="\t"+s[i]+"\n"}}throw new Error("Could not compile WebGL program '"+e+"'. \n\n"+t)}return r}linkProgram(e,t){let i=this.context.createProgram();if(this.context.attachShader(i,e),this.context.attachShader(i,t),this.context.linkProgram(i),!this.context.getProgramParameter(i,N.LINK_STATUS)){var r=this.context.getProgramInfoLog(i);throw new Error("Could not link WebGL program. \n\n"+r)}return i}setSampler(e,t,i){i?(this.context.texParameteri(t,N.TEXTURE_WRAP_S,e.wrapS),this.context.texParameteri(t,N.TEXTURE_WRAP_T,e.wrapT)):(this.context.texParameteri(t,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),this.context.texParameteri(t,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE)),i||e.minFilter==N.NEAREST||e.minFilter==N.LINEAR?this.context.texParameteri(t,N.TEXTURE_MIN_FILTER,e.minFilter):e.minFilter==N.NEAREST_MIPMAP_NEAREST||e.minFilter==N.NEAREST_MIPMAP_LINEAR?this.context.texParameteri(t,N.TEXTURE_MIN_FILTER,N.NEAREST):this.context.texParameteri(t,N.TEXTURE_MIN_FILTER,N.LINEAR),this.context.texParameteri(t,N.TEXTURE_MAG_FILTER,e.magFilter),this.context.supports_EXT_texture_filter_anisotropic&&this.context.texParameterf(t,this.context.anisotropy,this.context.maxAnisotropy)}}class U extends g{constructor(e,t=N.TEXTURE_2D,i=0,r,s,n=S,o){super(),this.uri=e,this.bufferView=r,this.mimeType=n,this.image=o,this.name=s,this.type=t,this.miplevel=i}resolveRelativePath(e){void 0!==this.uri&&(this.uri.startsWith("./")&&(this.uri=this.uri.substr(2)),this.uri=e+this.uri)}async load(e,t){void 0===this.image?await this.setImageFromBufferView(e)||await this.setImageFromFiles(t,e)||await this.setImageFromUri(e)||console.error("Was not able to resolve image with uri '%s'",this.uri):this.mimeType!==C&&console.error("image has already been loaded")}static loadHTMLImage(e){return new Promise(((t,i)=>{const r=new Image;r.addEventListener("load",(()=>t(r))),r.addEventListener("error",i),r.src=e,r.crossOrigin=""}))}async setImageFromUri(e){if(void 0===this.uri)return!1;if(this.mimeType===b)void 0!==e.ktxDecoder?this.image=await e.ktxDecoder.loadKtxFromUri(this.uri):console.warn("Loading of ktx images failed: KtxDecoder not initalized");else{if("undefined"==typeof Image||this.mimeType!==S&&this.mimeType!==R)return console.error("Unsupported image type "+this.mimeType),!1;this.image=await U.loadHTMLImage(this.uri).catch((e=>{console.error(e)}))}return!0}async setImageFromBufferView(e){const r=e.bufferViews[this.bufferView];if(void 0===r)return!1;const s=e.buffers[r.buffer].buffer,n=new Uint8Array(s,r.byteOffset,r.byteLength);if(this.mimeType===b)void 0!==e.ktxDecoder?this.image=await e.ktxDecoder.loadKtxFromBuffer(n):console.warn("Loading of ktx images failed: KtxDecoder not initalized");else if("undefined"==typeof Image||this.mimeType!==S&&this.mimeType!==R)if(this.mimeType===S)this.image=t.decode(n,{useTArray:!0});else{if(this.mimeType!==R)return console.error("Unsupported image type "+this.mimeType),!1;this.image=i.decode(n)}else{const e=new Blob([n],{type:this.mimeType}),t=URL.createObjectURL(e);this.image=await U.loadHTMLImage(t).catch((()=>{console.error("Could not load image from buffer view")}))}return!0}async setImageFromFiles(e,t){if(void 0===this.uri||void 0===e)return!1;let i=e.find((function(e){if(e.name===this.uri||e.fullPath===this.uri)return!0}),this);if(void 0===i)return!1;if(this.mimeType===b)if(void 0!==t.ktxDecoder){const e=new Uint8Array(await i.arrayBuffer());this.image=await t.ktxDecoder.loadKtxFromBuffer(e)}else console.warn("Loading of ktx images failed: KtxDecoder not initalized");else{if("undefined"==typeof Image||this.mimeType!==S&&this.mimeType!==R)return console.error("Unsupported image type "+this.mimeType),!1;{const e=await x.readAsDataURL(i).catch((()=>{console.error("Could not load image with FileReader")}));this.image=await U.loadHTMLImage(e).catch((()=>{console.error("Could not create image from FileReader image data")}))}}return!0}shouldGenerateMips(){return A(this.image.width)&&A(this.image.height)}}const y={NONE:"None",ACES_FAST:"ACES fast",ACES:"ACES"},L={NONE:"None",METALLIC:"Metallic",ROUGHNESS:"Roughness",NORMAL:"Normal",WORLDSPACENORMAL:"Worldspace Normal",GEOMETRYNORMAL:"Geometry Normal",TANGENT:"Tangent",BITANGENT:"Bitangent",BASECOLOR:"Base Color",OCCLUSION:"Occlusion",EMISSIVE:"Emissive",DIFFUSE:"Diffuse",SPECULAR:"Specular",CLEARCOAT:"ClearCoat",SHEEN:"Sheen",TRANSMISSION:"Transmission",ALPHA:"Alpha",F0:"F0"};class M{constructor(){this.gltf=void 0,this.environment=void 0,this.renderingParameters={morphing:!0,skinning:!0,clearColor:[58,64,74],exposure:1,usePunctual:!0,useIBL:!0,toneMap:y.LINEAR,debugOutput:L.NONE,environmentBackground:!1,environmentRotation:90},this.userCamera=new E,this.sceneIndex=0,this.cameraIndex=void 0,this.animationIndices=[],this.animationTimer=new p,this.variant=void 0}}class w{constructor(e,t,i){if(this.program=e,this.hash=t,this.uniforms=new Map,this.attributes=new Map,this.unknownAttributes=[],this.unknownUniforms=[],this.gl=i,void 0!==this.program){const e=this.gl.context.getProgramParameter(this.program,N.ACTIVE_UNIFORMS);for(let t=0;t<e;++t){const e=this.gl.context.getActiveUniform(this.program,t),i=this.gl.context.getUniformLocation(this.program,e.name);this.uniforms.set(e.name,{type:e.type,loc:i})}const t=this.gl.context.getProgramParameter(this.program,N.ACTIVE_ATTRIBUTES);for(let e=0;e<t;++e){const t=this.gl.context.getActiveAttrib(this.program,e),i=this.gl.context.getAttribLocation(this.program,t.name);this.attributes.set(t.name,i)}}}destroy(){void 0!==this.program&&this.deleteProgram(this.program),this.program=void 0}getAttributeLocation(e){const t=this.attributes.get(e);return void 0===t?(void 0===this.unknownAttributes.find((t=>t===e))&&(console.log("Attribute '%s' does not exist",e),this.unknownAttributes.push(e)),-1):t}getUniformLocation(e){const t=this.uniforms.get(e);return void 0===t?(void 0===this.unknownUniforms.find((t=>t===e))&&this.unknownUniforms.push(e),-1):t.loc}updateUniform(e,t,i=!0){t instanceof m?this.updateUniformStruct(e,t,i):Array.isArray(t)?this.updateUniformArray(e,t,i):this.updateUniformValue(e,t,i)}updateUniformArray(e,t,i){if(t[0]instanceof m)for(let r=0;r<t.length;++r){let s=t[r],n=e+"["+r+"]";this.updateUniform(n,s,i)}else{let r=e+"[0]",s=[];if(Array.isArray(t[0])||void 0!==t[0].length)for(let e=0;e<t.length;++e)s.push.apply(s,Array.from(t[e]));else s=t;if(0===s.length)return void console.error("Failed to flatten uniform array "+r);this.updateUniformValue(r,s,i)}}updateUniformStruct(e,t,i){let r=Object.keys(t);for(let s of r){let r=e+"."+s;this.updateUniform(r,t[s],i)}}updateUniformValue(e,t,i){const r=this.uniforms.get(e);if(void 0!==r)switch(r.type){case N.FLOAT:Array.isArray(t)||t instanceof Float32Array?this.gl.context.uniform1fv(r.loc,t):this.gl.context.uniform1f(r.loc,t);break;case N.FLOAT_VEC2:this.gl.context.uniform2fv(r.loc,t);break;case N.FLOAT_VEC3:this.gl.context.uniform3fv(r.loc,t);break;case N.FLOAT_VEC4:this.gl.context.uniform4fv(r.loc,t);break;case N.INT:Array.isArray(t)||t instanceof Uint32Array||t instanceof Int32Array?this.gl.context.uniform1iv(r.loc,t):this.gl.context.uniform1i(r.loc,t);break;case N.INT_VEC2:this.gl.context.uniform2iv(r.loc,t);break;case N.INT_VEC3:this.gl.context.uniform3iv(r.loc,t);break;case N.INT_VEC4:this.gl.context.uniform4iv(r.loc,t);break;case N.FLOAT_MAT2:this.gl.context.uniformMatrix2fv(r.loc,!1,t);break;case N.FLOAT_MAT3:this.gl.context.uniformMatrix3fv(r.loc,!1,t);break;case N.FLOAT_MAT4:this.gl.context.uniformMatrix4fv(r.loc,!1,t)}else i&&console.warn("Unkown uniform: "+e)}}class G{constructor(e,t){this.sources=e,this.shaders=new Map,this.programs=new Map,this.gl=t;for(let[e,t]of this.sources){let i=!1;for(let[e,r]of this.sources){const s="#include <"+e+">";if(t.includes(s)){for(t=t.replace(s,r);t.includes(s);)t=t.replace(s,"");i=!0}}i&&this.sources.set(e,t)}}destroy(){for(let[,e]of this.shaders.entries())this.gl.context.deleteShader(e),e=void 0;this.shaders.clear();for(let[,e]of this.programs)e.destroy();this.programs.clear()}selectShader(e,t){const i=this.sources.get(e);if(void 0===i)return console.log("Shader source for "+e+" not found"),null;const r=e.endsWith(".vert");let s=c(e),n="#version 300 es\n";for(let e of t)s^=c(e),n+="#define "+e+"\n";let o=this.shaders.get(s);return void 0===o&&(o=this.gl.compileShader(e,r,n+i),this.shaders.set(s,o)),s}getShaderProgram(e,t){const i=(r=e)^r+2654435769+((s=t)<<6)+(s>>2);var r,s;let n=this.programs.get(i);if(n)return n;{let r=this.gl.linkProgram(this.shaders.get(e),this.shaders.get(t));if(r){let e=new w(r,i,this.gl);return this.programs.set(i,e),e}}}}class F{constructor(t){this.shader=void 0,this.currentWidth=0,this.currentHeight=0,this.webGl=new I(t),this.opaqueRenderTexture=0,this.opaqueFramebuffer=0,this.opaqueDepthTexture=0,this.opaqueFramebufferWidth=1024,this.opaqueFramebufferHeight=1024;const i=new Map;i.set("primitive.vert","#define GLSLIFY 1\n#include <animation.glsl>\nin vec3 a_Position;out vec3 v_Position;\n#ifdef HAS_NORMALS\nin vec3 a_Normal;\n#endif\n#ifdef HAS_TANGENTS\nin vec4 a_Tangent;\n#endif\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\nout mat3 v_TBN;\n#else\nout vec3 v_Normal;\n#endif\n#endif\n#ifdef HAS_UV_SET1\nin vec2 a_UV1;\n#endif\n#ifdef HAS_UV_SET2\nin vec2 a_UV2;\n#endif\nout vec2 v_UVCoord1;out vec2 v_UVCoord2;\n#ifdef HAS_VERTEX_COLOR_VEC3\nin vec3 a_Color;out vec3 v_Color;\n#endif\n#ifdef HAS_VERTEX_COLOR_VEC4\nin vec4 a_Color;out vec4 v_Color;\n#endif\nuniform mat4 u_ViewProjectionMatrix;uniform mat4 u_ModelMatrix;uniform mat4 u_NormalMatrix;vec4 getPosition(){vec4 pos=vec4(a_Position,1.0);\n#ifdef USE_MORPHING\npos+=getTargetPosition();\n#endif\n#ifdef USE_SKINNING\npos=getSkinningMatrix()*pos;\n#endif\nreturn pos;}\n#ifdef HAS_NORMALS\nvec3 getNormal(){vec3 normal=a_Normal;\n#ifdef USE_MORPHING\nnormal+=getTargetNormal();\n#endif\n#ifdef USE_SKINNING\nnormal=mat3(getSkinningNormalMatrix())*normal;\n#endif\nreturn normalize(normal);}\n#endif\n#ifdef HAS_TANGENTS\nvec3 getTangent(){vec3 tangent=a_Tangent.xyz;\n#ifdef USE_MORPHING\ntangent+=getTargetTangent();\n#endif\n#ifdef USE_SKINNING\ntangent=mat3(getSkinningMatrix())*tangent;\n#endif\nreturn normalize(tangent);}\n#endif\nvoid main(){vec4 pos=u_ModelMatrix*getPosition();v_Position=vec3(pos.xyz)/pos.w;\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\nvec3 tangent=getTangent();vec3 normalW=normalize(vec3(u_NormalMatrix*vec4(getNormal(),0.0)));vec3 tangentW=normalize(vec3(u_ModelMatrix*vec4(tangent,0.0)));vec3 bitangentW=cross(normalW,tangentW)*a_Tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);\n#else\nv_Normal=normalize(vec3(u_NormalMatrix*vec4(getNormal(),0.0)));\n#endif\n#endif\nv_UVCoord1=vec2(0.0,0.0);v_UVCoord2=vec2(0.0,0.0);\n#ifdef HAS_UV_SET1\nv_UVCoord1=a_UV1;\n#endif\n#ifdef HAS_UV_SET2\nv_UVCoord2=a_UV2;\n#endif\n#if defined(HAS_VERTEX_COLOR_VEC3) || defined(HAS_VERTEX_COLOR_VEC4)\nv_Color=a_Color;\n#endif\ngl_Position=u_ViewProjectionMatrix*pos;}"),i.set("pbr.frag","precision highp float;\n#define GLSLIFY 1\n#include <tonemapping.glsl>\n#include <textures.glsl>\n#include <functions.glsl>\n#include <brdf.glsl>\n#include <punctual.glsl>\n#include <ibl.glsl>\nout vec4 g_finalColor;\n#ifdef USE_PUNCTUAL\nuniform Light u_Lights[LIGHT_COUNT+1];\n#endif\nuniform float u_MetallicFactor;uniform float u_RoughnessFactor;uniform vec4 u_BaseColorFactor;uniform vec3 u_SpecularFactor;uniform vec4 u_DiffuseFactor;uniform float u_GlossinessFactor;uniform float u_SheenRoughnessFactor;uniform vec3 u_SheenColorFactor;uniform float u_ClearcoatFactor;uniform float u_ClearcoatRoughnessFactor;uniform float u_TransmissionFactor;uniform float u_AlphaCutoff;uniform vec3 u_Camera;\n#ifdef MATERIAL_TRANSMISSION\nuniform ivec2 u_ScreenSize;\n#endif\nstruct MaterialInfo{float perceptualRoughness;vec3 f0;float alphaRoughness;vec3 albedoColor;vec3 f90;float metallic;vec3 n;vec3 baseColor;float sheenRoughnessFactor;vec3 sheenColorFactor;vec3 clearcoatF0;vec3 clearcoatF90;float clearcoatFactor;vec3 clearcoatNormal;float clearcoatRoughness;float transmissionFactor;};NormalInfo getNormalInfo(vec3 v){vec2 UV=getNormalUV();vec3 uv_dx=dFdx(vec3(UV,0.0));vec3 uv_dy=dFdy(vec3(UV,0.0));vec3 t_=(uv_dy.t*dFdx(v_Position)-uv_dx.t*dFdy(v_Position))/(uv_dx.s*uv_dy.t-uv_dy.s*uv_dx.t);vec3 n,t,b,ng;\n#ifdef HAS_TANGENTS\nt=normalize(v_TBN[0]);b=normalize(v_TBN[1]);ng=normalize(v_TBN[2]);\n#else\n#ifdef HAS_NORMALS\nng=normalize(v_Normal);\n#else\nng=normalize(cross(dFdx(v_Position),dFdy(v_Position)));\n#endif\nt=normalize(t_-ng*dot(ng,t_));b=cross(ng,t);\n#endif\nif(gl_FrontFacing==false){t*=-1.0;b*=-1.0;ng*=-1.0;}\n#ifdef HAS_NORMAL_MAP\nn=texture(u_NormalSampler,UV).rgb*2.0-vec3(1.0);n*=vec3(u_NormalScale,u_NormalScale,1.0);n=mat3(t,b,ng)*normalize(n);\n#else\nn=ng;\n#endif\nNormalInfo info;info.ng=ng;info.t=t;info.b=b;info.n=n;return info;}vec4 getBaseColor(){vec4 baseColor=vec4(1.0,1.0,1.0,1.0);\n#if defined(MATERIAL_SPECULARGLOSSINESS)\nbaseColor=u_DiffuseFactor;\n#elif defined(MATERIAL_METALLICROUGHNESS)\nbaseColor=u_BaseColorFactor;\n#endif\n#if defined(MATERIAL_SPECULARGLOSSINESS) && defined(HAS_DIFFUSE_MAP)\nbaseColor*=texture(u_DiffuseSampler,getDiffuseUV());\n#elif defined(MATERIAL_METALLICROUGHNESS) && defined(HAS_BASE_COLOR_MAP)\nbaseColor*=texture(u_BaseColorSampler,getBaseColorUV());\n#endif\nreturn baseColor*getVertexColor();}MaterialInfo getSpecularGlossinessInfo(MaterialInfo info){info.f0=u_SpecularFactor;info.perceptualRoughness=u_GlossinessFactor;\n#ifdef HAS_SPECULAR_GLOSSINESS_MAP\nvec4 sgSample=texture(u_SpecularGlossinessSampler,getSpecularGlossinessUV());info.perceptualRoughness*=sgSample.a;info.f0*=sgSample.rgb;\n#endif\ninfo.perceptualRoughness=1.0-info.perceptualRoughness;info.albedoColor=info.baseColor.rgb*(1.0-max(max(info.f0.r,info.f0.g),info.f0.b));return info;}MaterialInfo getMetallicRoughnessInfo(MaterialInfo info,float f0_ior){info.metallic=u_MetallicFactor;info.perceptualRoughness=u_RoughnessFactor;\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\nvec4 mrSample=texture(u_MetallicRoughnessSampler,getMetallicRoughnessUV());info.perceptualRoughness*=mrSample.g;info.metallic*=mrSample.b;\n#endif\nvec3 f0=vec3(f0_ior);info.albedoColor=mix(info.baseColor.rgb*(vec3(1.0)-f0),vec3(0),info.metallic);info.f0=mix(f0,info.baseColor.rgb,info.metallic);return info;}MaterialInfo getSheenInfo(MaterialInfo info){info.sheenColorFactor=u_SheenColorFactor;info.sheenRoughnessFactor=u_SheenRoughnessFactor;\n#ifdef HAS_SHEEN_COLOR_MAP\nvec4 sheenColorSample=texture(u_SheenColorSampler,getSheenColorUV());info.sheenColorFactor*=sheenColorSample.rgb;\n#endif\n#ifdef HAS_SHEEN_ROUGHNESS_MAP\nvec4 sheenRoughnessSample=texture(u_SheenRoughnessSampler,getSheenRoughnessUV());info.sheenRoughnessFactor*=sheenRoughnessSample.a;\n#endif\nreturn info;}\n#ifdef MATERIAL_TRANSMISSION\nMaterialInfo getTransmissionInfo(MaterialInfo info){info.transmissionFactor=u_TransmissionFactor;\n#ifdef HAS_TRANSMISSION_MAP\nvec4 transmissionSample=texture(u_TransmissionSampler,getTransmissionUV());info.transmissionFactor*=transmissionSample.r;\n#endif\nreturn info;}\n#endif\nMaterialInfo getClearCoatInfo(MaterialInfo info,NormalInfo normalInfo,float f0_ior){info.clearcoatFactor=u_ClearcoatFactor;info.clearcoatRoughness=u_ClearcoatRoughnessFactor;info.clearcoatF0=vec3(f0_ior);info.clearcoatF90=vec3(1.0);\n#ifdef HAS_CLEARCOAT_TEXTURE_MAP\nvec4 clearcoatSample=texture(u_ClearcoatSampler,getClearcoatUV());info.clearcoatFactor*=clearcoatSample.r;\n#endif\n#ifdef HAS_CLEARCOAT_ROUGHNESS_MAP\nvec4 clearcoatSampleRoughness=texture(u_ClearcoatRoughnessSampler,getClearcoatRoughnessUV());info.clearcoatRoughness*=clearcoatSampleRoughness.g;\n#endif\n#ifdef HAS_CLEARCOAT_NORMAL_MAP\nvec4 clearcoatSampleNormal=texture(u_ClearcoatNormalSampler,getClearcoatNormalUV());info.clearcoatNormal=normalize(clearcoatSampleNormal.xyz);\n#else\ninfo.clearcoatNormal=normalInfo.ng;\n#endif\ninfo.clearcoatRoughness=clamp(info.clearcoatRoughness,0.0,1.0);return info;}float albedoSheenScalingLUT(float NdotV,float sheenRoughnessFactor){return texture(u_SheenELUT,vec2(NdotV,sheenRoughnessFactor)).r;}void main(){vec4 baseColor=getBaseColor();\n#ifdef ALPHAMODE_OPAQUE\nbaseColor.a=1.0;\n#endif\n#ifdef MATERIAL_UNLIT\ng_finalColor=(vec4(linearTosRGB(baseColor.rgb),baseColor.a));return;\n#endif\nvec3 v=normalize(u_Camera-v_Position);NormalInfo normalInfo=getNormalInfo(v);vec3 n=normalInfo.n;vec3 t=normalInfo.t;vec3 b=normalInfo.b;float NdotV=clampedDot(n,v);float TdotV=clampedDot(t,v);float BdotV=clampedDot(b,v);MaterialInfo materialInfo;materialInfo.baseColor=baseColor.rgb;float ior=1.5;float f0_ior=0.04;\n#ifdef MATERIAL_SPECULARGLOSSINESS\nmaterialInfo=getSpecularGlossinessInfo(materialInfo);\n#endif\n#ifdef MATERIAL_METALLICROUGHNESS\nmaterialInfo=getMetallicRoughnessInfo(materialInfo,f0_ior);\n#endif\n#ifdef MATERIAL_SHEEN\nmaterialInfo=getSheenInfo(materialInfo);\n#endif\n#ifdef MATERIAL_CLEARCOAT\nmaterialInfo=getClearCoatInfo(materialInfo,normalInfo,f0_ior);\n#endif\n#ifdef MATERIAL_TRANSMISSION\nmaterialInfo=getTransmissionInfo(materialInfo);\n#endif\nmaterialInfo.perceptualRoughness=clamp(materialInfo.perceptualRoughness,0.0,1.0);materialInfo.metallic=clamp(materialInfo.metallic,0.0,1.0);materialInfo.alphaRoughness=materialInfo.perceptualRoughness*materialInfo.perceptualRoughness;float reflectance=max(max(materialInfo.f0.r,materialInfo.f0.g),materialInfo.f0.b);materialInfo.f90=vec3(clamp(reflectance*50.0,0.0,1.0));materialInfo.n=n;vec3 f_specular=vec3(0.0);vec3 f_diffuse=vec3(0.0);vec3 f_emissive=vec3(0.0);vec3 f_clearcoat=vec3(0.0);vec3 f_sheen=vec3(0.0);vec3 f_transmission=vec3(0.0);float albedoSheenScaling=1.0;\n#ifdef USE_IBL\nf_specular+=getIBLRadianceGGX(n,v,materialInfo.perceptualRoughness,materialInfo.f0);f_diffuse+=getIBLRadianceLambertian(n,materialInfo.albedoColor);\n#ifdef MATERIAL_CLEARCOAT\nf_clearcoat+=getIBLRadianceGGX(materialInfo.clearcoatNormal,v,materialInfo.clearcoatRoughness,materialInfo.clearcoatF0);\n#endif\n#ifdef MATERIAL_SHEEN\nf_sheen+=getIBLRadianceCharlie(n,v,materialInfo.sheenRoughnessFactor,materialInfo.sheenColorFactor);\n#endif\n#ifdef MATERIAL_TRANSMISSION\nvec2 normalizedFragCoord=vec2(0.0,0.0);normalizedFragCoord.x=gl_FragCoord.x/float(u_ScreenSize.x);normalizedFragCoord.y=gl_FragCoord.y/float(u_ScreenSize.y);f_transmission+=materialInfo.transmissionFactor*getIBLRadianceTransmission(n,u_Camera-v_Position,normalizedFragCoord,materialInfo.perceptualRoughness,materialInfo.baseColor,materialInfo.f0,materialInfo.f90);\n#endif\n#endif\nfloat ao=1.0;\n#ifdef HAS_OCCLUSION_MAP\nao=texture(u_OcclusionSampler,getOcclusionUV()).r;f_diffuse=mix(f_diffuse,f_diffuse*ao,u_OcclusionStrength);f_specular=mix(f_specular,f_specular*ao,u_OcclusionStrength);f_sheen=mix(f_sheen,f_sheen*ao,u_OcclusionStrength);f_clearcoat=mix(f_clearcoat,f_clearcoat*ao,u_OcclusionStrength);\n#endif\n#ifdef USE_PUNCTUAL\nfor(int i=0;i<LIGHT_COUNT;++i){Light light=u_Lights[i];vec3 pointToLight=-light.direction;float rangeAttenuation=1.0;float spotAttenuation=1.0;if(light.type!=LightType_Directional){pointToLight=light.position-v_Position;}if(light.type!=LightType_Directional){rangeAttenuation=getRangeAttenuation(light.range,length(pointToLight));}if(light.type==LightType_Spot){spotAttenuation=getSpotAttenuation(pointToLight,light.direction,light.outerConeCos,light.innerConeCos);}vec3 intensity=rangeAttenuation*spotAttenuation*light.intensity*light.color;vec3 l=normalize(pointToLight);vec3 h=normalize(l+v);float NdotL=clampedDot(n,l);float NdotV=clampedDot(n,v);float NdotH=clampedDot(n,h);float LdotH=clampedDot(l,h);float VdotH=clampedDot(v,h);if(NdotL>0.0||NdotV>0.0){f_diffuse+=intensity*NdotL*BRDF_lambertian(materialInfo.f0,materialInfo.f90,materialInfo.albedoColor,VdotH);f_specular+=intensity*NdotL*BRDF_specularGGX(materialInfo.f0,materialInfo.f90,materialInfo.alphaRoughness,VdotH,NdotL,NdotV,NdotH);\n#ifdef MATERIAL_SHEEN\nf_sheen+=intensity*getPunctualRadianceSheen(materialInfo.sheenColorFactor,materialInfo.sheenRoughnessFactor,NdotL,NdotV,NdotH);albedoSheenScaling=min(1.0-max3(materialInfo.sheenColorFactor)*albedoSheenScalingLUT(NdotV,materialInfo.sheenRoughnessFactor),1.0-max3(materialInfo.sheenColorFactor)*albedoSheenScalingLUT(NdotL,materialInfo.sheenRoughnessFactor));\n#endif\n#ifdef MATERIAL_CLEARCOAT\nf_clearcoat+=intensity*getPunctualRadianceClearCoat(materialInfo.clearcoatNormal,v,l,h,VdotH,materialInfo.clearcoatF0,materialInfo.clearcoatF90,materialInfo.clearcoatRoughness);\n#endif\n}\n#ifdef MATERIAL_TRANSMISSION\nf_transmission+=intensity*getPunctualRadianceTransmission(n,v,l,materialInfo.alphaRoughness,materialInfo.f0,materialInfo.f90,materialInfo.transmissionFactor,materialInfo.baseColor);\n#endif\n}\n#endif\nf_emissive=u_EmissiveFactor;\n#ifdef HAS_EMISSIVE_MAP\nf_emissive*=texture(u_EmissiveSampler,getEmissiveUV()).rgb;\n#endif\nvec3 color=vec3(0);float clearcoatFactor=0.0;vec3 clearcoatFresnel=vec3(0.0);\n#ifdef MATERIAL_CLEARCOAT\nclearcoatFactor=materialInfo.clearcoatFactor;clearcoatFresnel=F_Schlick(materialInfo.clearcoatF0,materialInfo.clearcoatF90,clampedDot(materialInfo.clearcoatNormal,v));\n#endif\n#ifdef MATERIAL_TRANSMISSION\nvec3 diffuse=mix(f_diffuse,f_transmission,materialInfo.transmissionFactor);\n#else\nvec3 diffuse=f_diffuse;\n#endif\ncolor=f_emissive+diffuse+f_specular;color=f_sheen+color*albedoSheenScaling;color=color*(1.0-clearcoatFactor*clearcoatFresnel)+f_clearcoat*clearcoatFactor;\n#ifndef DEBUG_OUTPUT\n#ifdef ALPHAMODE_MASK\nif(baseColor.a<u_AlphaCutoff){discard;}baseColor.a=1.0;\n#endif\ng_finalColor=vec4(toneMap(color),baseColor.a);\n#else\n#ifdef DEBUG_METALLIC\ng_finalColor.rgb=vec3(materialInfo.metallic);\n#endif\n#ifdef DEBUG_ROUGHNESS\ng_finalColor.rgb=vec3(materialInfo.perceptualRoughness);\n#endif\n#ifdef DEBUG_NORMAL\n#ifdef HAS_NORMAL_MAP\ng_finalColor.rgb=texture(u_NormalSampler,getNormalUV()).rgb;\n#else\ng_finalColor.rgb=vec3(0.5,0.5,1.0);\n#endif\n#endif\n#ifdef DEBUG_GEOMETRY_NORMAL\ng_finalColor.rgb=(normalInfo.ng+1.0)/2.0;\n#endif\n#ifdef DEBUG_WORLDSPACE_NORMAL\ng_finalColor.rgb=(n+1.0)/2.0;\n#endif\n#ifdef DEBUG_TANGENT\ng_finalColor.rgb=t*0.5+vec3(0.5);\n#endif\n#ifdef DEBUG_BITANGENT\ng_finalColor.rgb=b*0.5+vec3(0.5);\n#endif\n#ifdef DEBUG_BASECOLOR\ng_finalColor.rgb=linearTosRGB(materialInfo.baseColor);\n#endif\n#ifdef DEBUG_OCCLUSION\ng_finalColor.rgb=vec3(ao);\n#endif\n#ifdef DEBUG_F0\ng_finalColor.rgb=materialInfo.f0;\n#endif\n#ifdef DEBUG_FEMISSIVE\ng_finalColor.rgb=linearTosRGB(f_emissive);\n#endif\n#ifdef DEBUG_FSPECULAR\ng_finalColor.rgb=linearTosRGB(f_specular);\n#endif\n#ifdef DEBUG_FDIFFUSE\ng_finalColor.rgb=linearTosRGB(f_diffuse);\n#endif\n#ifdef DEBUG_FCLEARCOAT\ng_finalColor.rgb=linearTosRGB(f_clearcoat);\n#endif\n#ifdef DEBUG_FSHEEN\ng_finalColor.rgb=linearTosRGB(f_sheen);\n#endif\n#ifdef DEBUG_FTRANSMISSION\ng_finalColor.rgb=linearTosRGB(f_transmission);\n#endif\n#ifdef DEBUG_ALPHA\ng_finalColor.rgb=vec3(baseColor.a);\n#endif\ng_finalColor.a=1.0;\n#endif\n}"),i.set("brdf.glsl","#define GLSLIFY 1\nvec3 F_Schlick(vec3 f0,vec3 f90,float VdotH){return f0+(f90-f0)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}float V_GGX(float NdotL,float NdotV,float alphaRoughness){float alphaRoughnessSq=alphaRoughness*alphaRoughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-alphaRoughnessSq)+alphaRoughnessSq);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-alphaRoughnessSq)+alphaRoughnessSq);float GGX=GGXV+GGXL;if(GGX>0.0){return 0.5/GGX;}return 0.0;}float D_GGX(float NdotH,float alphaRoughness){float alphaRoughnessSq=alphaRoughness*alphaRoughness;float f=(NdotH*NdotH)*(alphaRoughnessSq-1.0)+1.0;return alphaRoughnessSq/(M_PI*f*f);}float lambdaSheenNumericHelper(float x,float alphaG){float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}float lambdaSheen(float cosTheta,float alphaG){if(abs(cosTheta)<0.5){return exp(lambdaSheenNumericHelper(cosTheta,alphaG));}else{return exp(2.0*lambdaSheenNumericHelper(0.5,alphaG)-lambdaSheenNumericHelper(1.0-cosTheta,alphaG));}}float V_Sheen(float NdotL,float NdotV,float sheenRoughness){sheenRoughness=max(sheenRoughness,0.000001);float alphaG=sheenRoughness*sheenRoughness;return clamp(1.0/((1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG))*(4.0*NdotV*NdotL)),0.0,1.0);}float D_Charlie(float sheenRoughness,float NdotH){sheenRoughness=max(sheenRoughness,0.000001);float alphaG=sheenRoughness*sheenRoughness;float invR=1.0/alphaG;float cos2h=NdotH*NdotH;float sin2h=1.0-cos2h;return(2.0+invR)*pow(sin2h,invR*0.5)/(2.0*M_PI);}vec3 BRDF_lambertian(vec3 f0,vec3 f90,vec3 diffuseColor,float VdotH){return(1.0-F_Schlick(f0,f90,VdotH))*(diffuseColor/M_PI);}vec3 BRDF_specularGGX(vec3 f0,vec3 f90,float alphaRoughness,float VdotH,float NdotL,float NdotV,float NdotH){vec3 F=F_Schlick(f0,f90,VdotH);float Vis=V_GGX(NdotL,NdotV,alphaRoughness);float D=D_GGX(NdotH,alphaRoughness);return F*Vis*D;}vec3 BRDF_specularSheen(vec3 sheenColor,float sheenRoughness,float NdotL,float NdotV,float NdotH){float sheenDistribution=D_Charlie(sheenRoughness,NdotH);float sheenVisibility=V_Sheen(NdotL,NdotV,sheenRoughness);return sheenColor*sheenDistribution*sheenVisibility;}"),i.set("ibl.glsl","#define GLSLIFY 1\nvec3 getDiffuseLight(vec3 n){return texture(u_LambertianEnvSampler,u_envRotation*n).rgb;}vec4 getSpecularSample(vec3 reflection,float lod){return textureLod(u_GGXEnvSampler,u_envRotation*reflection,lod);}vec4 getSheenSample(vec3 reflection,float lod){return textureLod(u_CharlieEnvSampler,u_envRotation*reflection,lod);}vec3 getIBLRadianceGGX(vec3 n,vec3 v,float perceptualRoughness,vec3 specularColor){float NdotV=clampedDot(n,v);float lod=clamp(perceptualRoughness*float(u_MipCount),0.0,float(u_MipCount));vec3 reflection=normalize(reflect(-v,n));vec2 brdfSamplePoint=clamp(vec2(NdotV,perceptualRoughness),vec2(0.0,0.0),vec2(1.0,1.0));vec2 brdf=texture(u_GGXLUT,brdfSamplePoint).rg;vec4 specularSample=getSpecularSample(reflection,lod);vec3 specularLight=specularSample.rgb;return specularLight*(specularColor*brdf.x+brdf.y);}vec3 getTransmissionSample(vec2 fragCoord,float perceptualRoughness){float framebufferLod=log2(float(u_TransmissionFramebufferSize.x))*perceptualRoughness;vec3 transmittedLight=textureLod(u_TransmissionFramebufferSampler,fragCoord.xy,framebufferLod).rgb;transmittedLight=sRGBToLinear(transmittedLight);return transmittedLight;}vec3 getIBLRadianceTransmission(vec3 n,vec3 v,vec2 fragCoord,float perceptualRoughness,vec3 baseColor,vec3 f0,vec3 f90){float NdotV=clampedDot(n,v);vec2 brdfSamplePoint=clamp(vec2(NdotV,perceptualRoughness),vec2(0.0,0.0),vec2(1.0,1.0));vec2 brdf=texture(u_GGXLUT,brdfSamplePoint).rg;vec3 specularColor=f0*brdf.x+f90*brdf.y;float lod=clamp(perceptualRoughness*float(u_MipCount),0.0,float(u_MipCount));vec3 transmissionVector=normalize(-v);vec3 transmittedLight=getTransmissionSample(fragCoord.xy,perceptualRoughness);return(1.0-specularColor)*transmittedLight*baseColor;}vec3 getIBLRadianceLambertian(vec3 n,vec3 diffuseColor){vec3 diffuseLight=getDiffuseLight(n);return diffuseLight*diffuseColor;}vec3 getIBLRadianceCharlie(vec3 n,vec3 v,float sheenRoughness,vec3 sheenColor){float NdotV=clampedDot(n,v);float lod=clamp(sheenRoughness*float(u_MipCount),0.0,float(u_MipCount));vec3 reflection=normalize(reflect(-v,n));vec2 brdfSamplePoint=clamp(vec2(NdotV,sheenRoughness),vec2(0.0,0.0),vec2(1.0,1.0));float brdf=texture(u_CharlieLUT,brdfSamplePoint).b;vec4 sheenSample=getSheenSample(reflection,lod);vec3 sheenLight=sheenSample.rgb;return sheenLight*sheenColor*brdf;}"),i.set("punctual.glsl","#define GLSLIFY 1\nstruct Light{vec3 direction;float range;vec3 color;float intensity;vec3 position;float innerConeCos;float outerConeCos;int type;float padding1;float padding2;};const int LightType_Directional=0;const int LightType_Point=1;const int LightType_Spot=2;float getRangeAttenuation(float range,float distance){if(range<=0.0){return 1.0/pow(distance,2.0);}return max(min(1.0-pow(distance/range,4.0),1.0),0.0)/pow(distance,2.0);}float getSpotAttenuation(vec3 pointToLight,vec3 spotDirection,float outerConeCos,float innerConeCos){float actualCos=dot(normalize(spotDirection),normalize(-pointToLight));if(actualCos>outerConeCos){if(actualCos<innerConeCos){return smoothstep(outerConeCos,innerConeCos,actualCos);}return 1.0;}return 0.0;}vec3 getPunctualRadianceTransmission(vec3 normal,vec3 view,vec3 pointToLight,float alphaRoughness,vec3 f0,vec3 f90,float transmissionPercentage,vec3 baseColor){vec3 n=normalize(normal);vec3 v=normalize(view);vec3 l=normalize(pointToLight);vec3 l_mirror=normalize(l+2.0*n*dot(-l,n));vec3 h=normalize(l_mirror+v);float D=D_GGX(clamp(dot(n,h),0.0,1.0),alphaRoughness);vec3 F=F_Schlick(f0,f90,clamp(dot(v,h),0.0,1.0));float T=transmissionPercentage;float Vis=V_GGX(clamp(dot(n,l_mirror),0.0,1.0),clamp(dot(n,v),0.0,1.0),alphaRoughness);vec3 f_transmission=(1.0-F)*T*baseColor*D*Vis;return f_transmission;}vec3 getPunctualRadianceClearCoat(vec3 clearcoatNormal,vec3 v,vec3 l,vec3 h,float VdotH,vec3 f0,vec3 f90,float clearcoatRoughness){float NdotL=clampedDot(clearcoatNormal,l);float NdotV=clampedDot(clearcoatNormal,v);float NdotH=clampedDot(clearcoatNormal,h);return NdotL*BRDF_specularGGX(f0,f90,clearcoatRoughness*clearcoatRoughness,VdotH,NdotL,NdotV,NdotH);}vec3 getPunctualRadianceSheen(vec3 sheenColor,float sheenRoughness,float NdotL,float NdotV,float NdotH){return NdotL*BRDF_specularSheen(sheenColor,sheenRoughness,NdotL,NdotV,NdotH);}"),i.set("tonemapping.glsl","#define GLSLIFY 1\nuniform float u_Exposure;const float GAMMA=2.2;const float INV_GAMMA=1.0/GAMMA;const mat3 ACESInputMat=mat3(0.59719,0.07600,0.02840,0.35458,0.90834,0.13383,0.04823,0.01566,0.83777);const mat3 ACESOutputMat=mat3(1.60475,-0.10208,-0.00327,-0.53108,1.10813,-0.07276,-0.07367,-0.00605,1.07602);vec3 linearTosRGB(vec3 color){return pow(color,vec3(INV_GAMMA));}vec3 sRGBToLinear(vec3 srgbIn){return vec3(pow(srgbIn.xyz,vec3(GAMMA)));}vec4 sRGBToLinear(vec4 srgbIn){return vec4(sRGBToLinear(srgbIn.xyz),srgbIn.w);}vec3 toneMapACESFast(vec3 color){color*=0.6;const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0);}vec3 RRTAndODTFit(vec3 color){vec3 a=color*(color+0.0245786)-0.000090537;vec3 b=color*(0.983729*color+0.4329510)+0.238081;return a/b;}vec3 toneMapACES(vec3 color){color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=clamp(color,0.0,1.0);return color;}vec3 toneMap(vec3 color){color*=u_Exposure;\n#ifdef TONEMAP_ACES_FAST\nreturn linearTosRGB(toneMapACESFast(color));\n#endif\n#ifdef TONEMAP_ACES\nreturn linearTosRGB(toneMapACES(color));\n#endif\nreturn linearTosRGB(color);}"),i.set("textures.glsl","#define GLSLIFY 1\nin vec2 v_UVCoord1;in vec2 v_UVCoord2;uniform int u_MipCount;uniform samplerCube u_LambertianEnvSampler;uniform samplerCube u_GGXEnvSampler;uniform sampler2D u_GGXLUT;uniform samplerCube u_CharlieEnvSampler;uniform sampler2D u_CharlieLUT;uniform sampler2D u_SheenELUT;uniform mat3 u_envRotation;uniform sampler2D u_NormalSampler;uniform float u_NormalScale;uniform int u_NormalUVSet;uniform mat3 u_NormalUVTransform;uniform vec3 u_EmissiveFactor;uniform sampler2D u_EmissiveSampler;uniform int u_EmissiveUVSet;uniform mat3 u_EmissiveUVTransform;uniform sampler2D u_OcclusionSampler;uniform int u_OcclusionUVSet;uniform float u_OcclusionStrength;uniform mat3 u_OcclusionUVTransform;uniform sampler2D u_BaseColorSampler;uniform int u_BaseColorUVSet;uniform mat3 u_BaseColorUVTransform;uniform sampler2D u_MetallicRoughnessSampler;uniform int u_MetallicRoughnessUVSet;uniform mat3 u_MetallicRoughnessUVTransform;uniform sampler2D u_DiffuseSampler;uniform int u_DiffuseUVSet;uniform mat3 u_DiffuseUVTransform;uniform sampler2D u_SpecularGlossinessSampler;uniform int u_SpecularGlossinessUVSet;uniform mat3 u_SpecularGlossinessUVTransform;uniform sampler2D u_ClearcoatSampler;uniform int u_ClearcoatUVSet;uniform mat3 u_ClearcoatUVTransform;uniform sampler2D u_ClearcoatRoughnessSampler;uniform int u_ClearcoatRoughnessUVSet;uniform mat3 u_ClearcoatRoughnessUVTransform;uniform sampler2D u_ClearcoatNormalSampler;uniform int u_ClearcoatNormalUVSet;uniform mat3 u_ClearcoatNormalUVTransform;uniform sampler2D u_SheenColorSampler;uniform int u_SheenColorUVSet;uniform mat3 u_SheenColorUVTransform;uniform sampler2D u_SheenRoughnessSampler;uniform int u_SheenRoughnessUVSet;uniform mat3 u_SheenRoughnessUVTransform;uniform sampler2D u_TransmissionSampler;uniform int u_TransmissionUVSet;uniform mat3 u_TransmissionUVTransform;uniform sampler2D u_TransmissionFramebufferSampler;uniform ivec2 u_TransmissionFramebufferSize;vec2 getNormalUV(){vec3 uv=vec3(u_NormalUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_NORMAL_UV_TRANSFORM\nuv*=u_NormalUVTransform;\n#endif\nreturn uv.xy;}vec2 getEmissiveUV(){vec3 uv=vec3(u_EmissiveUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_EMISSIVE_UV_TRANSFORM\nuv*=u_EmissiveUVTransform;\n#endif\nreturn uv.xy;}vec2 getOcclusionUV(){vec3 uv=vec3(u_OcclusionUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_OCCLUSION_UV_TRANSFORM\nuv*=u_OcclusionUVTransform;\n#endif\nreturn uv.xy;}vec2 getBaseColorUV(){vec3 uv=vec3(u_BaseColorUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_BASECOLOR_UV_TRANSFORM\nuv*=u_BaseColorUVTransform;\n#endif\nreturn uv.xy;}vec2 getMetallicRoughnessUV(){vec3 uv=vec3(u_MetallicRoughnessUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_METALLICROUGHNESS_UV_TRANSFORM\nuv*=u_MetallicRoughnessUVTransform;\n#endif\nreturn uv.xy;}vec2 getSpecularGlossinessUV(){vec3 uv=vec3(u_SpecularGlossinessUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_SPECULARGLOSSINESS_UV_TRANSFORM\nuv*=u_SpecularGlossinessUVTransform;\n#endif\nreturn uv.xy;}vec2 getDiffuseUV(){vec3 uv=vec3(u_DiffuseUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_DIFFUSE_UV_TRANSFORM\nuv*=u_DiffuseUVTransform;\n#endif\nreturn uv.xy;}vec2 getClearcoatUV(){vec3 uv=vec3(u_ClearcoatUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_CLEARCOAT_UV_TRANSFORM\nuv*=u_ClearcoatUVTransform;\n#endif\nreturn uv.xy;}vec2 getClearcoatRoughnessUV(){vec3 uv=vec3(u_ClearcoatRoughnessUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_CLEARCOATROUGHNESS_UV_TRANSFORM\nuv*=u_ClearcoatRoughnessUVTransform;\n#endif\nreturn uv.xy;}vec2 getClearcoatNormalUV(){vec3 uv=vec3(u_ClearcoatNormalUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_CLEARCOATNORMAL_UV_TRANSFORM\nuv*=u_ClearcoatNormalUVTransform;\n#endif\nreturn uv.xy;}vec2 getSheenColorUV(){vec3 uv=vec3(u_SheenColorUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_SHEENCOLOR_UV_TRANSFORM\nuv*=u_SheenColorUVTransform;\n#endif\nreturn uv.xy;}vec2 getSheenRoughnessUV(){vec3 uv=vec3(u_SheenRoughnessUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_SHEENROUGHNESS_UV_TRANSFORM\nuv*=u_SheenRoughnessUVTransform;\n#endif\nreturn uv.xy;}vec2 getTransmissionUV(){vec3 uv=vec3(u_TransmissionUVSet<1 ? v_UVCoord1 : v_UVCoord2,1.0);\n#ifdef HAS_TRANSMISSION_UV_TRANSFORM\nuv*=u_TransmissionUVTransform;\n#endif\nreturn uv.xy;}"),i.set("functions.glsl","#define GLSLIFY 1\nconst float M_PI=3.141592653589793;in vec3 v_Position;\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\nin mat3 v_TBN;\n#else\nin vec3 v_Normal;\n#endif\n#endif\n#ifdef HAS_VERTEX_COLOR_VEC3\nin vec3 v_Color;\n#endif\n#ifdef HAS_VERTEX_COLOR_VEC4\nin vec4 v_Color;\n#endif\nvec4 getVertexColor(){vec4 color=vec4(1.0,1.0,1.0,1.0);\n#ifdef HAS_VERTEX_COLOR_VEC3\ncolor.rgb=v_Color.rgb;\n#endif\n#ifdef HAS_VERTEX_COLOR_VEC4\ncolor=v_Color;\n#endif\nreturn color;}struct NormalInfo{vec3 ng;vec3 n;vec3 t;vec3 b;};float clampedDot(vec3 x,vec3 y){return clamp(dot(x,y),0.0,1.0);}float max3(vec3 v){return max(max(v.x,v.y),v.z);}"),i.set("animation.glsl","#define GLSLIFY 1\n#ifdef HAS_TARGET_POSITION0\nin vec3 a_Target_Position0;\n#endif\n#ifdef HAS_TARGET_POSITION1\nin vec3 a_Target_Position1;\n#endif\n#ifdef HAS_TARGET_POSITION2\nin vec3 a_Target_Position2;\n#endif\n#ifdef HAS_TARGET_POSITION3\nin vec3 a_Target_Position3;\n#endif\n#ifdef HAS_TARGET_POSITION4\nin vec3 a_Target_Position4;\n#endif\n#ifdef HAS_TARGET_POSITION5\nin vec3 a_Target_Position5;\n#endif\n#ifdef HAS_TARGET_POSITION6\nin vec3 a_Target_Position6;\n#endif\n#ifdef HAS_TARGET_POSITION7\nin vec3 a_Target_Position7;\n#endif\n#ifdef HAS_TARGET_NORMAL0\nin vec3 a_Target_Normal0;\n#endif\n#ifdef HAS_TARGET_NORMAL1\nin vec3 a_Target_Normal1;\n#endif\n#ifdef HAS_TARGET_NORMAL2\nin vec3 a_Target_Normal2;\n#endif\n#ifdef HAS_TARGET_NORMAL3\nin vec3 a_Target_Normal3;\n#endif\n#ifdef HAS_TARGET_TANGENT0\nin vec3 a_Target_Tangent0;\n#endif\n#ifdef HAS_TARGET_TANGENT1\nin vec3 a_Target_Tangent1;\n#endif\n#ifdef HAS_TARGET_TANGENT2\nin vec3 a_Target_Tangent2;\n#endif\n#ifdef HAS_TARGET_TANGENT3\nin vec3 a_Target_Tangent3;\n#endif\n#ifdef USE_MORPHING\nuniform float u_morphWeights[WEIGHT_COUNT];\n#endif\n#ifdef HAS_JOINT_SET1\nin vec4 a_Joint1;\n#endif\n#ifdef HAS_JOINT_SET2\nin vec4 a_Joint2;\n#endif\n#ifdef HAS_WEIGHT_SET1\nin vec4 a_Weight1;\n#endif\n#ifdef HAS_WEIGHT_SET2\nin vec4 a_Weight2;\n#endif\n#ifdef USE_SKINNING\nuniform mat4 u_jointMatrix[JOINT_COUNT];uniform mat4 u_jointNormalMatrix[JOINT_COUNT];\n#endif\n#ifdef USE_SKINNING\nmat4 getSkinningMatrix(){mat4 skin=mat4(0);\n#if defined(HAS_WEIGHT_SET1) && defined(HAS_JOINT_SET1)\nskin+=a_Weight1.x*u_jointMatrix[int(a_Joint1.x)]+a_Weight1.y*u_jointMatrix[int(a_Joint1.y)]+a_Weight1.z*u_jointMatrix[int(a_Joint1.z)]+a_Weight1.w*u_jointMatrix[int(a_Joint1.w)];\n#endif\n#if defined(HAS_WEIGHT_SET2) && defined(HAS_JOINT_SET2)\nskin+=a_Weight2.x*u_jointMatrix[int(a_Joint2.x)]+a_Weight2.y*u_jointMatrix[int(a_Joint2.y)]+a_Weight2.z*u_jointMatrix[int(a_Joint2.z)]+a_Weight2.w*u_jointMatrix[int(a_Joint2.w)];\n#endif\nreturn skin;}mat4 getSkinningNormalMatrix(){mat4 skin=mat4(0);\n#if defined(HAS_WEIGHT_SET1) && defined(HAS_JOINT_SET1)\nskin+=a_Weight1.x*u_jointNormalMatrix[int(a_Joint1.x)]+a_Weight1.y*u_jointNormalMatrix[int(a_Joint1.y)]+a_Weight1.z*u_jointNormalMatrix[int(a_Joint1.z)]+a_Weight1.w*u_jointNormalMatrix[int(a_Joint1.w)];\n#endif\n#if defined(HAS_WEIGHT_SET2) && defined(HAS_JOINT_SET2)\nskin+=a_Weight2.x*u_jointNormalMatrix[int(a_Joint2.x)]+a_Weight2.y*u_jointNormalMatrix[int(a_Joint2.y)]+a_Weight2.z*u_jointNormalMatrix[int(a_Joint2.z)]+a_Weight2.w*u_jointNormalMatrix[int(a_Joint2.w)];\n#endif\nreturn skin;}\n#endif\n#ifdef USE_MORPHING\nvec4 getTargetPosition(){vec4 pos=vec4(0);\n#ifdef HAS_TARGET_POSITION0\npos.xyz+=u_morphWeights[0]*a_Target_Position0;\n#endif\n#ifdef HAS_TARGET_POSITION1\npos.xyz+=u_morphWeights[1]*a_Target_Position1;\n#endif\n#ifdef HAS_TARGET_POSITION2\npos.xyz+=u_morphWeights[2]*a_Target_Position2;\n#endif\n#ifdef HAS_TARGET_POSITION3\npos.xyz+=u_morphWeights[3]*a_Target_Position3;\n#endif\n#ifdef HAS_TARGET_POSITION4\npos.xyz+=u_morphWeights[4]*a_Target_Position4;\n#endif\nreturn pos;}vec3 getTargetNormal(){vec3 normal=vec3(0);\n#ifdef HAS_TARGET_NORMAL0\nnormal+=u_morphWeights[0]*a_Target_Normal0;\n#endif\n#ifdef HAS_TARGET_NORMAL1\nnormal+=u_morphWeights[1]*a_Target_Normal1;\n#endif\n#ifdef HAS_TARGET_NORMAL2\nnormal+=u_morphWeights[2]*a_Target_Normal2;\n#endif\n#ifdef HAS_TARGET_NORMAL3\nnormal+=u_morphWeights[3]*a_Target_Normal3;\n#endif\n#ifdef HAS_TARGET_NORMAL4\nnormal+=u_morphWeights[4]*a_Target_Normal4;\n#endif\nreturn normal;}vec3 getTargetTangent(){vec3 tangent=vec3(0);\n#ifdef HAS_TARGET_TANGENT0\ntangent+=u_morphWeights[0]*a_Target_Tangent0;\n#endif\n#ifdef HAS_TARGET_TANGENT1\ntangent+=u_morphWeights[1]*a_Target_Tangent1;\n#endif\n#ifdef HAS_TARGET_TANGENT2\ntangent+=u_morphWeights[2]*a_Target_Tangent2;\n#endif\n#ifdef HAS_TARGET_TANGENT3\ntangent+=u_morphWeights[3]*a_Target_Tangent3;\n#endif\n#ifdef HAS_TARGET_TANGENT4\ntangent+=u_morphWeights[4]*a_Target_Tangent4;\n#endif\nreturn tangent;}\n#endif\n"),this.shaderCache=new G(i,this.webGl);this.webGl.loadWebGlExtensions(["EXT_texture_filter_anisotropic","OES_texture_float_linear"]),this.visibleLights=[],this.viewMatrix=e.mat4.create(),this.projMatrix=e.mat4.create(),this.viewProjectionMatrix=e.mat4.create(),this.currentCameraPosition=e.vec3.create(),this.init()}init(){const e=this.webGl.context;e.pixelStorei(N.UNPACK_COLORSPACE_CONVERSION_WEBGL,N.NONE),e.enable(N.DEPTH_TEST),e.depthFunc(N.LEQUAL),e.colorMask(!0,!0,!0,!0),e.clearDepth(1),this.opaqueRenderTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.opaqueRenderTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.opaqueFramebufferWidth,this.opaqueFramebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),this.opaqueDepthTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.opaqueDepthTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT16,this.opaqueFramebufferWidth,this.opaqueFramebufferHeight,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),e.bindTexture(e.TEXTURE_2D,null),this.opaqueFramebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.opaqueFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.opaqueRenderTexture,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.opaqueDepthTexture,0),e.viewport(0,0,this.currentWidth,this.currentHeight),e.bindFramebuffer(e.FRAMEBUFFER,null)}resize(e,t){this.currentWidth===e&&this.currentHeight===t||(this.currentHeight=t,this.currentWidth=e,this.webGl.context.viewport(0,0,e,t))}clearFrame(e){this.webGl.context.bindFramebuffer(this.webGl.context.FRAMEBUFFER,null),this.webGl.context.clearColor(e[0]/255,e[1]/255,e[2]/255,1),this.webGl.context.clear(N.COLOR_BUFFER_BIT|N.DEPTH_BUFFER_BIT),this.webGl.context.bindFramebuffer(this.webGl.context.FRAMEBUFFER,this.opaqueFramebuffer),this.webGl.context.clearColor(e[0]/255,e[1]/255,e[2]/255,1),this.webGl.context.clear(N.COLOR_BUFFER_BIT|N.DEPTH_BUFFER_BIT),this.webGl.context.bindFramebuffer(this.webGl.context.FRAMEBUFFER,null)}drawScene(t,i){let r;r=void 0===t.cameraIndex?t.userCamera:t.gltf.cameras[t.cameraIndex].clone(),r.aspectRatio=this.currentWidth/this.currentHeight,this.projMatrix=r.getProjectionMatrix(),this.viewMatrix=r.getViewMatrix(t.gltf),this.currentCameraPosition=r.getPosition(t.gltf),this.visibleLights=this.getVisibleLights(t.gltf,i),e.mat4.multiply(this.viewProjectionMatrix,this.projMatrix,this.viewMatrix);const s=i.gatherNodes(t.gltf);for(const e of s)void 0!==e.mesh&&void 0!==e.skin&&this.updateSkin(t,e);const n=s.filter((e=>void 0!==e.mesh)).reduce(((e,i)=>e.concat(t.gltf.meshes[i.mesh].primitives.map((e=>({node:i,primitive:e}))))),[]).filter((({node:e,primitive:t})=>void 0!==t.material)),o=n.filter((({node:e,primitive:i})=>"BLEND"!==t.gltf.materials[i.material].alphaMode&&(void 0===t.gltf.materials[i.material].extensions||void 0===t.gltf.materials[i.material].extensions.KHR_materials_transmission)));let a=n.filter((({node:e,primitive:i})=>"BLEND"===t.gltf.materials[i.material].alphaMode&&(void 0===t.gltf.materials[i.material].extensions||void 0===t.gltf.materials[i.material].extensions.KHR_materials_transmission)));a=r.sortPrimitivesByDepth(t.gltf,a),this.webGl.context.bindFramebuffer(this.webGl.context.FRAMEBUFFER,this.opaqueFramebuffer),this.webGl.context.viewport(0,0,this.opaqueFramebufferWidth,this.opaqueFramebufferHeight);for(const e of o)this.drawPrimitive(t,e.primitive,e.node,this.viewProjectionMatrix);for(const e of a)this.drawPrimitive(t,e.primitive,e.node,this.viewProjectionMatrix);this.webGl.context.viewport(0,0,this.currentWidth,this.currentHeight),this.webGl.context.bindTexture(this.webGl.context.TEXTURE_2D,this.opaqueRenderTexture),this.webGl.context.generateMipmap(this.webGl.context.TEXTURE_2D),this.webGl.context.bindFramebuffer(this.webGl.context.FRAMEBUFFER,null);for(const e of o)this.drawPrimitive(t,e.primitive,e.node,this.viewProjectionMatrix);for(const e of a)this.drawPrimitive(t,e.primitive,e.node,this.viewProjectionMatrix);let l=n.filter((({node:e,primitive:i})=>void 0!==t.gltf.materials[i.material].extensions&&void 0!==t.gltf.materials[i.material].extensions.KHR_materials_transmission));l=r.sortPrimitivesByDepth(t.gltf,l);for(const e of l)this.drawPrimitive(t,e.primitive,e.node,this.viewProjectionMatrix,this.opaqueRenderTexture)}drawPrimitive(t,i,r,s,n){if(i.skip)return;let o;if(void 0!==i.mappings&&"default"!=t.variant){const e=t.gltf.variants.map((e=>e.name)).indexOf(t.variant);let r=i.material;i.mappings.forEach((t=>{t.variants.indexOf(e)>=0&&(r=t.material)})),o=t.gltf.materials[r]}else o=t.gltf.materials[i.material];let a=[];this.pushVertParameterDefines(a,t.renderingParameters,t.gltf,r,i),a=i.getDefines().concat(a);let l=o.getDefines().concat(a);this.pushFragParameterDefines(l,t);const c=this.shaderCache.selectShader(o.getShaderIdentifier(),l),u=this.shaderCache.selectShader(i.getShaderIdentifier(),a);if(c&&u&&(this.shader=this.shaderCache.getShaderProgram(c,u)),void 0===this.shader)return;this.webGl.context.useProgram(this.shader.program),t.renderingParameters.usePunctual&&this.applyLights(t.gltf),this.shader.updateUniform("u_ViewProjectionMatrix",s),this.shader.updateUniform("u_ModelMatrix",r.worldTransform),this.shader.updateUniform("u_NormalMatrix",r.normalMatrix,!1),this.shader.updateUniform("u_Exposure",t.renderingParameters.exposure,!1),this.shader.updateUniform("u_Camera",this.currentCameraPosition,!1),this.updateAnimationUniforms(t,r,i),e.mat4.determinant(r.worldTransform)<0?this.webGl.context.frontFace(N.CW):this.webGl.context.frontFace(N.CCW),o.doubleSided?this.webGl.context.disable(N.CULL_FACE):this.webGl.context.enable(N.CULL_FACE),"BLEND"===o.alphaMode?(this.webGl.context.enable(N.BLEND),this.webGl.context.blendFuncSeparate(N.SRC_ALPHA,N.ONE_MINUS_SRC_ALPHA,N.SRC_ALPHA,N.ONE_MINUS_SRC_ALPHA),this.webGl.context.blendEquation(N.FUNC_ADD)):this.webGl.context.disable(N.BLEND);const f=void 0!==i.indices;if(f&&!this.webGl.setIndices(t.gltf,i.indices))return;let h=0;for(const e of i.glAttributes){const i=t.gltf.accessors[e.accessor];h=i.count;const r=this.shader.getAttributeLocation(e.name);if(!(r<0)&&!this.webGl.enableAttribute(t.gltf,r,i))return}for(let[e,t]of o.getProperties().entries())this.shader.updateUniform(e,t);for(let e=0;e<o.textures.length;++e){let i=o.textures[e];const r=this.shader.getUniformLocation(i.samplerName);if(!(r<0)&&!this.webGl.setTexture(r,t.gltf,i,e))return}let d=o.textures.length;if(t.renderingParameters.useIBL&&void 0!==t.environment&&(d=this.applyEnvironmentMap(t,d)),t.renderingParameters.usePunctual&&this.webGl.setTexture(this.shader.getUniformLocation("u_SheenELUT"),t.gltf,t.environment.sheenELUT,d++),void 0!==n&&(this.webGl.context.activeTexture(N.TEXTURE0+d),this.webGl.context.bindTexture(this.webGl.context.TEXTURE_2D,this.opaqueRenderTexture),this.webGl.context.uniform1i(this.shader.getUniformLocation("u_TransmissionFramebufferSampler"),d),d++,this.webGl.context.uniform2i(this.shader.getUniformLocation("u_ScreenSize"),this.currentWidth,this.currentHeight),this.webGl.context.uniform2i(this.shader.getUniformLocation("u_TransmissionFramebufferSize"),this.opaqueFramebufferWidth,this.opaqueFramebufferHeight)),f){const e=t.gltf.accessors[i.indices];this.webGl.context.drawElements(i.mode,e.count,e.componentType,0)}else this.webGl.context.drawArrays(i.mode,0,h);for(const e of i.glAttributes){const t=this.shader.getAttributeLocation(e.name);t<0||this.webGl.context.disableVertexAttribArray(t)}}getVisibleLights(e,t){let i=[];for(let r of e.lights)void 0!==r.node&&t.includesNode(e,r.node)&&i.push(r);return i}updateSkin(e,t){if(e.renderingParameters.skinning&&void 0!==e.gltf.skins){e.gltf.skins[t.skin].computeJoints(e.gltf,t)}}pushVertParameterDefines(e,t,i,r,s){if(t.skinning&&void 0!==r.skin&&s.hasWeights&&s.hasJoints){const t=i.skins[r.skin];e.push("USE_SKINNING 1"),e.push("JOINT_COUNT "+t.jointMatrices.length)}if(t.morphing&&void 0!==r.mesh&&s.targets.length>0){const t=i.meshes[r.mesh];void 0!==t.weights&&t.weights.length>0&&(e.push("USE_MORPHING 1"),e.push("WEIGHT_COUNT "+Math.min(t.weights.length,8)))}}updateAnimationUniforms(e,t,i){if(e.renderingParameters.skinning&&void 0!==t.skin&&i.hasWeights&&i.hasJoints){const r=e.gltf.skins[t.skin];this.shader.updateUniform("u_jointMatrix",r.jointMatrices),i.hasNormals&&this.shader.updateUniform("u_jointNormalMatrix",r.jointNormalMatrices)}if(e.renderingParameters.morphing&&void 0!==t.mesh&&i.targets.length>0){const i=e.gltf.meshes[t.mesh];void 0!==i.weights&&i.weights.length>0&&this.shader.updateUniformArray("u_morphWeights",i.weights)}}pushFragParameterDefines(e,t){switch(t.renderingParameters.usePunctual&&(e.push("USE_PUNCTUAL 1"),e.push("LIGHT_COUNT "+this.visibleLights.length)),t.renderingParameters.useIBL&&t.environment&&e.push("USE_IBL 1"),t.renderingParameters.toneMap){case y.ACES_FAST:e.push("TONEMAP_ACES_FAST 1");break;case y.ACES:e.push("TONEMAP_ACES 1")}switch(t.renderingParameters.debugOutput!==L.NONE&&e.push("DEBUG_OUTPUT 1"),t.renderingParameters.debugOutput){case L.METALLIC:e.push("DEBUG_METALLIC 1");break;case L.ROUGHNESS:e.push("DEBUG_ROUGHNESS 1");break;case L.NORMAL:e.push("DEBUG_NORMAL 1");break;case L.WORLDSPACENORMAL:e.push("DEBUG_WORLDSPACE_NORMAL 1");break;case L.GEOMETRYNORMAL:e.push("DEBUG_GEOMETRY_NORMAL 1");break;case L.TANGENT:e.push("DEBUG_TANGENT 1");break;case L.BITANGENT:e.push("DEBUG_BITANGENT 1");break;case L.BASECOLOR:e.push("DEBUG_BASECOLOR 1");break;case L.OCCLUSION:e.push("DEBUG_OCCLUSION 1");break;case L.EMISSIVE:e.push("DEBUG_FEMISSIVE 1");break;case L.SPECULAR:e.push("DEBUG_FSPECULAR 1");break;case L.DIFFUSE:e.push("DEBUG_FDIFFUSE 1");break;case L.THICKNESS:e.push("DEBUG_THICKNESS 1");break;case L.CLEARCOAT:e.push("DEBUG_FCLEARCOAT 1");break;case L.SHEEN:e.push("DEBUG_FSHEEN 1");break;case L.SUBSURFACE:e.push("DEBUG_FSUBSURFACE 1");break;case L.TRANSMISSION:e.push("DEBUG_FTRANSMISSION 1");break;case L.F0:e.push("DEBUG_F0 1");break;case L.ALPHA:e.push("DEBUG_ALPHA 1")}}applyLights(e){let t=[];for(let i of this.visibleLights)t.push(i.toUniform(e));t.length>0&&this.shader.updateUniform("u_Lights",t)}applyEnvironmentMap(t,i){const r=t.environment;this.webGl.setTexture(this.shader.getUniformLocation("u_LambertianEnvSampler"),r,r.diffuseEnvMap,i++),this.webGl.setTexture(this.shader.getUniformLocation("u_GGXEnvSampler"),r,r.specularEnvMap,i++),this.webGl.setTexture(this.shader.getUniformLocation("u_GGXLUT"),r,r.lut,i++),this.webGl.setTexture(this.shader.getUniformLocation("u_CharlieEnvSampler"),r,r.sheenEnvMap,i++),this.webGl.setTexture(this.shader.getUniformLocation("u_CharlieLUT"),r,r.sheenLUT,i++),this.shader.updateUniform("u_MipCount",r.mipCount);let s=e.mat4.create();e.mat4.rotateY(s,s,t.renderingParameters.environmentRotation/180*Math.PI);let n=e.mat3.create();return e.mat3.fromMat4(n,s),this.shader.updateUniform("u_envRotation",n),i}destroy(){this.shaderCache.destroy()}}var O=function(e,t){return function(){for(var i=new Array(arguments.length),r=0;r<i.length;r++)i[r]=arguments[r];return e.apply(t,i)}},P=Object.prototype.toString;function V(e){return"[object Array]"===P.call(e)}function H(e){return void 0===e}function D(e){return null!==e&&"object"==typeof e}function B(e){if("[object Object]"!==P.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function k(e){return"[object Function]"===P.call(e)}function X(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),V(e))for(var i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.call(null,e[s],s,e)}var z={isArray:V,isArrayBuffer:function(e){return"[object ArrayBuffer]"===P.call(e)},isBuffer:function(e){return null!==e&&!H(e)&&null!==e.constructor&&!H(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:D,isPlainObject:B,isUndefined:H,isDate:function(e){return"[object Date]"===P.call(e)},isFile:function(e){return"[object File]"===P.call(e)},isBlob:function(e){return"[object Blob]"===P.call(e)},isFunction:k,isStream:function(e){return D(e)&&k(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:X,merge:function e(){var t={};function i(i,r){B(t[r])&&B(i)?t[r]=e(t[r],i):B(i)?t[r]=e({},i):V(i)?t[r]=i.slice():t[r]=i}for(var r=0,s=arguments.length;r<s;r++)X(arguments[r],i);return t},extend:function(e,t,i){return X(t,(function(t,r){e[r]=i&&"function"==typeof t?O(t,i):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}};function W(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var J=function(e,t,i){if(!t)return e;var r;if(i)r=i(t);else if(z.isURLSearchParams(t))r=t.toString();else{var s=[];z.forEach(t,(function(e,t){null!=e&&(z.isArray(e)?t+="[]":e=[e],z.forEach(e,(function(e){z.isDate(e)?e=e.toISOString():z.isObject(e)&&(e=JSON.stringify(e)),s.push(W(t)+"="+W(e))})))})),r=s.join("&")}if(r){var n=e.indexOf("#");-1!==n&&(e=e.slice(0,n)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e};function j(){this.handlers=[]}j.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},j.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},j.prototype.forEach=function(e){z.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var K=j,q=function(e,t,i){return z.forEach(i,(function(i){e=i(e,t)})),e},Y=function(e){return!(!e||!e.__CANCEL__)},Q=function(e,t){z.forEach(e,(function(i,r){r!==t&&r.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[r])}))},Z=function(e,t,i,r,s){return function(e,t,i,r,s){return e.config=t,i&&(e.code=i),e.request=r,e.response=s,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,i,r,s)},$=z.isStandardBrowserEnv()?{write:function(e,t,i,r,s,n){var o=[];o.push(e+"="+encodeURIComponent(t)),z.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),z.isString(r)&&o.push("path="+r),z.isString(s)&&o.push("domain="+s),!0===n&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},ee=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],te=z.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function r(e){var r=e;return t&&(i.setAttribute("href",r),r=i.href),i.setAttribute("href",r),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=r(window.location.href),function(t){var i=z.isString(t)?r(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0},ie=function(e){return new Promise((function(t,i){var r=e.data,s=e.headers;z.isFormData(r)&&delete s["Content-Type"];var n=new XMLHttpRequest;if(e.auth){var o=e.auth.username||"",a=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";s.Authorization="Basic "+btoa(o+":"+a)}var l,c,u=(l=e.baseURL,c=e.url,l&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(c)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(l,c):c);if(n.open(e.method.toUpperCase(),J(u,e.params,e.paramsSerializer),!0),n.timeout=e.timeout,n.onreadystatechange=function(){if(n&&4===n.readyState&&(0!==n.status||n.responseURL&&0===n.responseURL.indexOf("file:"))){var r,s,o,a,l,c="getAllResponseHeaders"in n?(r=n.getAllResponseHeaders(),l={},r?(z.forEach(r.split("\n"),(function(e){if(a=e.indexOf(":"),s=z.trim(e.substr(0,a)).toLowerCase(),o=z.trim(e.substr(a+1)),s){if(l[s]&&ee.indexOf(s)>=0)return;l[s]="set-cookie"===s?(l[s]?l[s]:[]).concat([o]):l[s]?l[s]+", "+o:o}})),l):l):null,u={data:e.responseType&&"text"!==e.responseType?n.response:n.responseText,status:n.status,statusText:n.statusText,headers:c,config:e,request:n};!function(e,t,i){var r=i.config.validateStatus;i.status&&r&&!r(i.status)?t(Z("Request failed with status code "+i.status,i.config,null,i.request,i)):e(i)}(t,i,u),n=null}},n.onabort=function(){n&&(i(Z("Request aborted",e,"ECONNABORTED",n)),n=null)},n.onerror=function(){i(Z("Network Error",e,null,n)),n=null},n.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(Z(t,e,"ECONNABORTED",n)),n=null},z.isStandardBrowserEnv()){var f=(e.withCredentials||te(u))&&e.xsrfCookieName?$.read(e.xsrfCookieName):void 0;f&&(s[e.xsrfHeaderName]=f)}if("setRequestHeader"in n&&z.forEach(s,(function(e,t){void 0===r&&"content-type"===t.toLowerCase()?delete s[t]:n.setRequestHeader(t,e)})),z.isUndefined(e.withCredentials)||(n.withCredentials=!!e.withCredentials),e.responseType)try{n.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&n.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&n.upload&&n.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){n&&(n.abort(),i(e),n=null)})),r||(r=null),n.send(r)}))},re={"Content-Type":"application/x-www-form-urlencoded"};function se(e,t){!z.isUndefined(e)&&z.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var ne,oe={adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(ne=ie),ne),transformRequest:[function(e,t){return Q(t,"Accept"),Q(t,"Content-Type"),z.isFormData(e)||z.isArrayBuffer(e)||z.isBuffer(e)||z.isStream(e)||z.isFile(e)||z.isBlob(e)?e:z.isArrayBufferView(e)?e.buffer:z.isURLSearchParams(e)?(se(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):z.isObject(e)?(se(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300}};oe.headers={common:{Accept:"application/json, text/plain, */*"}},z.forEach(["delete","get","head"],(function(e){oe.headers[e]={}})),z.forEach(["post","put","patch"],(function(e){oe.headers[e]=z.merge(re)}));var ae=oe;function le(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var ce=function(e){return le(e),e.headers=e.headers||{},e.data=q(e.data,e.headers,e.transformRequest),e.headers=z.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),z.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||ae.adapter)(e).then((function(t){return le(e),t.data=q(t.data,t.headers,e.transformResponse),t}),(function(t){return Y(t)||(le(e),t&&t.response&&(t.response.data=q(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},ue=function(e,t){t=t||{};var i={},r=["url","method","data"],s=["headers","auth","proxy","params"],n=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],o=["validateStatus"];function a(e,t){return z.isPlainObject(e)&&z.isPlainObject(t)?z.merge(e,t):z.isPlainObject(t)?z.merge({},t):z.isArray(t)?t.slice():t}function l(r){z.isUndefined(t[r])?z.isUndefined(e[r])||(i[r]=a(void 0,e[r])):i[r]=a(e[r],t[r])}z.forEach(r,(function(e){z.isUndefined(t[e])||(i[e]=a(void 0,t[e]))})),z.forEach(s,l),z.forEach(n,(function(r){z.isUndefined(t[r])?z.isUndefined(e[r])||(i[r]=a(void 0,e[r])):i[r]=a(void 0,t[r])})),z.forEach(o,(function(r){r in t?i[r]=a(e[r],t[r]):r in e&&(i[r]=a(void 0,e[r]))}));var c=r.concat(s).concat(n).concat(o),u=Object.keys(e).concat(Object.keys(t)).filter((function(e){return-1===c.indexOf(e)}));return z.forEach(u,l),i};function fe(e){this.defaults=e,this.interceptors={request:new K,response:new K}}fe.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=ue(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[ce,void 0],i=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)i=i.then(t.shift(),t.shift());return i},fe.prototype.getUri=function(e){return e=ue(this.defaults,e),J(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},z.forEach(["delete","get","head","options"],(function(e){fe.prototype[e]=function(t,i){return this.request(ue(i||{},{method:e,url:t,data:(i||{}).data}))}})),z.forEach(["post","put","patch"],(function(e){fe.prototype[e]=function(t,i,r){return this.request(ue(r||{},{method:e,url:t,data:i}))}}));var he=fe;function de(e){this.message=e}de.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},de.prototype.__CANCEL__=!0;var me=de;function pe(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;e((function(e){i.reason||(i.reason=new me(e),t(i.reason))}))}pe.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},pe.source=function(){var e;return{token:new pe((function(t){e=t})),cancel:e}};var ge=pe;function _e(e){var t=new he(e),i=O(he.prototype.request,t);return z.extend(i,he.prototype,t),z.extend(i,t),i}var Te=_e(ae);Te.Axios=he,Te.create=function(e){return _e(ue(Te.defaults,e))},Te.Cancel=me,Te.CancelToken=ge,Te.isCancel=Y,Te.all=function(e){return Promise.all(e)},Te.spread=function(e){return function(t){return e.apply(null,t)}},Te.isAxiosError=function(e){return"object"==typeof e&&!0===e.isAxiosError};var ve=Te,Ee=Te;ve.default=Ee;var Ae=ve;class xe extends g{constructor(){super(),this.bufferView=void 0,this.byteOffset=0,this.componentType=void 0,this.normalized=!1,this.count=void 0,this.type=void 0,this.max=void 0,this.min=void 0,this.sparse=void 0,this.name=void 0,this.glBuffer=void 0,this.typedView=void 0,this.filteredView=void 0}getTypedView(e){if(void 0!==this.typedView)return this.typedView;if(void 0!==this.bufferView){const t=e.bufferViews[this.bufferView],i=e.buffers[t.buffer],r=this.byteOffset+t.byteOffset,s=this.getComponentSize(this.componentType);let n=this.getComponentCount(this.type);0!==t.byteStride&&(n=t.byteStride/s);let o=this.count*n;switch(o*s>i.buffer.byteLength-r&&(o=(i.buffer.byteLength-r)/s,console.warn("Count in accessor '"+(this.name?this.name:"")+"' is too large.")),this.componentType){case N.BYTE:this.typedView=new Int8Array(i.buffer,r,o);break;case N.UNSIGNED_BYTE:this.typedView=new Uint8Array(i.buffer,r,o);break;case N.SHORT:this.typedView=new Int16Array(i.buffer,r,o);break;case N.UNSIGNED_SHORT:this.typedView=new Uint16Array(i.buffer,r,o);break;case N.UNSIGNED_INT:this.typedView=new Uint32Array(i.buffer,r,o);break;case N.FLOAT:this.typedView=new Float32Array(i.buffer,r,o)}}return void 0===this.typedView?console.warn("Failed to convert buffer view to typed view!: "+this.bufferView):void 0!==this.sparse&&this.applySparse(e,this.typedView),this.typedView}getDeinterlacedView(e){if(void 0!==this.filteredView)return this.filteredView;if(void 0!==this.bufferView){const t=e.bufferViews[this.bufferView],i=e.buffers[t.buffer],r=this.byteOffset+t.byteOffset,s=this.getComponentSize(this.componentType),n=this.getComponentCount(this.type),o=this.count*n;let a=0!==t.byteStride?t.byteStride:n*s,l=new DataView(i.buffer,r,this.count*a),c="getFloat32";switch(this.componentType){case N.BYTE:this.filteredView=new Int8Array(o),c="getInt8";break;case N.UNSIGNED_BYTE:this.filteredView=new Uint8Array(o),c="getUint8";break;case N.SHORT:this.filteredView=new Int16Array(o),c="getInt16";break;case N.UNSIGNED_SHORT:this.filteredView=new Uint16Array(o),c="getUint16";break;case N.UNSIGNED_INT:this.filteredView=new Uint32Array(o),c="getUint32";break;case N.FLOAT:this.filteredView=new Float32Array(o),c="getFloat32"}for(let e=0;e<o;++e){let t=Math.floor(e/n)*a+e%n*s;this.filteredView[e]=l[c](t,!0)}}return void 0===this.filteredView?console.warn("Failed to convert buffer view to filtered view!: "+this.bufferView):void 0!==this.sparse&&this.applySparse(e,this.filteredView),this.filteredView}applySparse(e,t){const i=e.bufferViews[this.sparse.indices.bufferView],r=e.buffers[i.buffer],s=this.sparse.indices.byteOffset+i.byteOffset,n=this.getComponentSize(this.sparse.indices.componentType);let o=1;0!==i.byteStride&&(o=i.byteStride/n);const a=this.sparse.count*o;let l;switch(this.sparse.indices.componentType){case N.UNSIGNED_BYTE:l=new Uint8Array(r.buffer,s,a);break;case N.UNSIGNED_SHORT:l=new Uint16Array(r.buffer,s,a);break;case N.UNSIGNED_INT:l=new Uint32Array(r.buffer,s,a)}const c=e.bufferViews[this.sparse.values.bufferView],u=e.buffers[c.buffer],f=this.sparse.values.byteOffset+c.byteOffset,h=this.getComponentSize(this.componentType);let d=this.getComponentCount(this.type);0!==c.byteStride&&(d=c.byteStride/h);const m=this.sparse.count*d;let p;switch(this.componentType){case N.BYTE:p=new Int8Array(u.buffer,f,m);break;case N.UNSIGNED_BYTE:p=new Uint8Array(u.buffer,f,m);break;case N.SHORT:p=new Int16Array(u.buffer,f,m);break;case N.UNSIGNED_SHORT:p=new Uint16Array(u.buffer,f,m);break;case N.UNSIGNED_INT:p=new Uint32Array(u.buffer,f,m);break;case N.FLOAT:p=new Float32Array(u.buffer,f,m)}for(let e=0;e<this.sparse.count;++e)for(let i=0;i<d;++i)t[l[e]*d+i]=p[e*d+i]}getComponentCount(e){return Se.get(e)}getComponentSize(e){switch(e){case N.BYTE:case N.UNSIGNED_BYTE:return 1;case N.SHORT:case N.UNSIGNED_SHORT:return 2;case N.UNSIGNED_INT:case N.FLOAT:return 4;default:return 0}}destroy(){void 0!==this.glBuffer&&WebGl.context.deleteBuffer(this.glBuffer),this.glBuffer=void 0}}const Se=new Map([["SCALAR",1],["VEC2",2],["VEC3",3],["VEC4",4],["MAT2",4],["MAT3",9],["MAT4",16]]);class Re extends g{constructor(){super(),this.uri=void 0,this.byteLength=void 0,this.name=void 0,this.buffer=void 0}load(e,t){if(void 0!==this.buffer)return void console.error("buffer has already been loaded");const i=this;return new Promise((function(r){i.setBufferFromFiles(t,r)||i.sefBufferFromUri(e,r)||(console.error("Was not able to resolve buffer with uri '%s'",i.uri),r())}))}sefBufferFromUri(e,t){if(void 0===this.uri)return!1;const i=this;return Ae.get(d(e.path)+this.uri,{responseType:"arraybuffer"}).then((function(e){i.buffer=e.data,t()})),!0}setBufferFromFiles(e,t){if(void 0===this.uri||void 0===e)return!1;const i=e.find((function(e){if(e.name===this.uri||e.fullPath===this.uri)return!0}),this);if(void 0===i)return!1;const r=this,s=new FileReader;return s.onloadend=function(e){r.buffer=e.target.result,t()},s.readAsArrayBuffer(i),!0}}class be extends g{constructor(){super(),this.buffer=void 0,this.byteOffset=0,this.byteLength=void 0,this.byteStride=0,this.target=void 0,this.name=void 0}}class Ce extends g{constructor(e="directional",t=[1,1,1],i=1,r=0,s=Math.PI/4,n=-1,o,a){super(),this.type=e,this.color=t,this.intensity=i,this.innerConeAngle=r,this.outerConeAngle=s,this.range=n,this.name=o,this.node=a}initGl(e,t){super.initGl(e,t);for(let t=0;t<e.nodes.length;t++){const i=e.nodes[t].extensions;if(void 0===i)continue;const r=i.KHR_lights_punctual;if(void 0===r)continue;const s=r.light;if(e.lights[s]===this){this.node=t;break}}}fromJson(e){super.fromJson(e),void 0!==e.spot&&l(this,e.spot)}toUniform(t){const i=new ye;if(void 0!==this.node){const r=t.nodes[this.node].worldTransform;var s=e.vec3.fromValues(1,1,1);e.mat4.getScaling(s,r);const a=e.mat4.create();for(const e of[0,1,2])a[e]=r[e]/s[0],a[e+4]=r[e+4]/s[1],a[e+8]=r[e+8]/s[2];var n=e.quat.create();e.mat4.getRotation(n,a),e.quat.normalize(n,n);const l=e.vec3.fromValues(0,0,-1);e.vec3.transformQuat(i.direction,l,n);var o=e.vec3.fromValues(0,0,0);e.mat4.getTranslation(o,r),i.position=o}switch(i.range=this.range,i.color=r(this.color),i.intensity=this.intensity,i.innerConeCos=Math.cos(this.innerConeAngle),i.outerConeCos=Math.cos(this.outerConeAngle),this.type){case"spot":i.type=Ue;break;case"point":i.type=Ie;break;case"directional":default:i.type=Ne}return i}}const Ne=0,Ie=1,Ue=2;class ye extends m{constructor(){super();const t=e.vec3.fromValues(-.7399,-.6428,-.1983);this.direction=t,this.range=-1,this.color=r([1,1,1]),this.intensity=1,this.position=r([0,0,0]),this.innerConeCos=0,this.outerConeCos=Math.PI/4,this.type=Ne,this.padding1=0,this.padding2=0}}class Le extends g{constructor(){super(),this.rotation=r([0,0,0,1]),this.brightnessFactor=1,this.brightnessOffset=0,this.specularEnvironmentTexture=void 0,this.diffuseEnvironmentTexture=void 0,this.sheenEnvironmentTexture=void 0,this.levelCount=1}fromJson(e){super.fromJson(e),void 0!==e.extensions&&this.fromJsonExtensions(e.extensions)}fromJsonExtensions(e){void 0!==e.KHR_materials_sheen&&(this.sheenEnvironmentTexture=e.KHR_materials_sheen.sheenEnvironmentTexture)}initGl(e,t){if(void 0!==this.diffuseEnvironmentTexture){e.textures[this.diffuseEnvironmentTexture].type=N.TEXTURE_CUBE_MAP}if(void 0!==this.specularEnvironmentTexture){const t=e.textures[this.specularEnvironmentTexture];t.type=N.TEXTURE_CUBE_MAP;const i=e.images[t.source];this.levelCount=i.image.levelCount}if(void 0!==this.sheenEnvironmentTexture){const t=e.textures[this.sheenEnvironmentTexture];t.type=N.TEXTURE_CUBE_MAP;const i=e.images[t.source];this.levelCount!==i.image.levelCount&&console.error("Specular and sheen do not have same level count")}}}class Me extends g{constructor(e,t,i=N.TEXTURE_2D,r){super(),this.sampler=e,this.source=t,this.glTexture=r,this.type=i,this.initialized=!1,this.mipLevelCount=0}initGl(e,t){void 0===this.sampler&&(this.sampler=e.samplers.length-1),n(this,e,t)}fromJson(e){super.fromJson(e),void 0!==e.extensions&&void 0!==e.extensions.KHR_texture_basisu&&void 0!==e.extensions.KHR_texture_basisu.source&&(this.source=e.extensions.KHR_texture_basisu.source)}destroy(){void 0!==this.glTexture&&WebGl.context.deleteTexture(this.glTexture),this.glTexture=void 0}}class we{constructor(e,t=0,i=!0,r="",s=!0){this.index=e,this.texCoord=t,this.linear=i,this.samplerName=r,this.strength=1,this.scale=1,this.generateMips=s,this.extensions=void 0}initGl(e,t){n(this,e,t)}fromJson(e){l(this,e)}}class Ge extends g{constructor(){super(),this.name=void 0,this.pbrMetallicRoughness=void 0,this.normalTexture=void 0,this.occlusionTexture=void 0,this.emissiveTexture=void 0,this.emissiveFactor=e.vec3.fromValues(0,0,0),this.alphaMode="OPAQUE",this.alphaCutoff=.5,this.doubleSided=!1,this.type="unlit",this.textures=[],this.properties=new Map,this.defines=[]}static createDefault(){const t=new Ge;t.type="MR",t.name="Default Material",t.defines.push("MATERIAL_METALLICROUGHNESS 1");const i=e.vec4.fromValues(1,1,1,1);return t.properties.set("u_BaseColorFactor",i),t.properties.set("u_MetallicFactor",1),t.properties.set("u_RoughnessFactor",1),t}getShaderIdentifier(){switch(this.type){default:case"SG":case"MR":return"pbr.frag"}}getDefines(){return this.defines}getProperties(){return this.properties}getTextures(){return this.textures}parseTextureInfoExtensions(t,i){if(void 0!==t.extensions&&void 0!==t.extensions.KHR_texture_transform){const s=t.extensions.KHR_texture_transform;void 0!==s.texCoord&&(t.texCoord=s.texCoord);let n=e.mat3.create(),o=e.mat3.create(),a=e.mat3.create();if(void 0!==s.rotation){const e=Math.sin(s.rotation),t=Math.cos(s.rotation);n=r([t,e,0,-e,t,0,0,0,1])}void 0!==s.scale&&(o=r([s.scale[0],0,0,0,s.scale[1],0,0,0,1])),void 0!==s.offset&&(a=r([1,0,s.offset[0],0,1,s.offset[1],0,0,1]));let l=e.mat3.create();e.mat3.multiply(l,n,o),e.mat3.multiply(l,l,a),this.defines.push("HAS_"+i.toUpperCase()+"_UV_TRANSFORM 1"),this.properties.set("u_"+i+"UVTransform",l)}}initGl(t,i){if(void 0!==this.normalTexture&&(this.normalTexture.samplerName="u_NormalSampler",this.parseTextureInfoExtensions(this.normalTexture,"Normal"),this.textures.push(this.normalTexture),this.defines.push("HAS_NORMAL_MAP 1"),this.properties.set("u_NormalScale",this.normalTexture.scale),this.properties.set("u_NormalUVSet",this.normalTexture.texCoord)),void 0!==this.occlusionTexture&&(this.occlusionTexture.samplerName="u_OcclusionSampler",this.parseTextureInfoExtensions(this.occlusionTexture,"Occlusion"),this.textures.push(this.occlusionTexture),this.defines.push("HAS_OCCLUSION_MAP 1"),this.properties.set("u_OcclusionStrength",this.occlusionTexture.strength),this.properties.set("u_OcclusionUVSet",this.occlusionTexture.texCoord)),this.properties.set("u_EmissiveFactor",this.emissiveFactor),void 0!==this.emissiveTexture&&(this.emissiveTexture.samplerName="u_EmissiveSampler",this.parseTextureInfoExtensions(this.emissiveTexture,"Emissive"),this.textures.push(this.emissiveTexture),this.defines.push("HAS_EMISSIVE_MAP 1"),this.properties.set("u_EmissiveUVSet",this.emissiveTexture.texCoord)),void 0!==this.baseColorTexture&&(this.baseColorTexture.samplerName="u_BaseColorSampler",this.parseTextureInfoExtensions(this.baseColorTexture,"BaseColor"),this.textures.push(this.baseColorTexture),this.defines.push("HAS_BASE_COLOR_MAP 1"),this.properties.set("u_BaseColorUVSet",this.baseColorTexture.texCoord)),void 0!==this.metallicRoughnessTexture&&(this.metallicRoughnessTexture.samplerName="u_MetallicRoughnessSampler",this.parseTextureInfoExtensions(this.metallicRoughnessTexture,"MetallicRoughness"),this.textures.push(this.metallicRoughnessTexture),this.defines.push("HAS_METALLIC_ROUGHNESS_MAP 1"),this.properties.set("u_MetallicRoughnessUVSet",this.metallicRoughnessTexture.texCoord)),void 0!==this.diffuseTexture&&(this.diffuseTexture.samplerName="u_DiffuseSampler",this.parseTextureInfoExtensions(this.diffuseTexture,"Diffuse"),this.textures.push(this.diffuseTexture),this.defines.push("HAS_DIFFUSE_MAP 1"),this.properties.set("u_DiffuseUVSet",this.diffuseTexture.texCoord)),void 0!==this.specularGlossinessTexture&&(this.specularGlossinessTexture.samplerName="u_SpecularGlossinessSampler",this.parseTextureInfoExtensions(this.specularGlossinessTexture,"SpecularGlossiness"),this.textures.push(this.specularGlossinessTexture),this.defines.push("HAS_SPECULAR_GLOSSINESS_MAP 1"),this.properties.set("u_SpecularGlossinessUVSet",this.specularGlossinessTexture.texCoord)),"MASK"===this.alphaMode?(this.defines.push("ALPHAMODE_MASK 1"),this.properties.set("u_AlphaCutoff",this.alphaCutoff)):"OPAQUE"===this.alphaMode&&this.defines.push("ALPHAMODE_OPAQUE 1"),void 0!==this.pbrMetallicRoughness&&"SG"!==this.type){this.defines.push("MATERIAL_METALLICROUGHNESS 1");let t=e.vec4.fromValues(1,1,1,1),i=1,s=1;void 0!==this.pbrMetallicRoughness.baseColorFactor&&(t=r(this.pbrMetallicRoughness.baseColorFactor)),void 0!==this.pbrMetallicRoughness.metallicFactor&&(i=this.pbrMetallicRoughness.metallicFactor),void 0!==this.pbrMetallicRoughness.roughnessFactor&&(s=this.pbrMetallicRoughness.roughnessFactor),this.properties.set("u_BaseColorFactor",t),this.properties.set("u_MetallicFactor",i),this.properties.set("u_RoughnessFactor",s)}if(void 0!==this.extensions){if(void 0!==this.extensions.KHR_materials_unlit&&this.defines.push("MATERIAL_UNLIT 1"),void 0!==this.extensions.KHR_materials_pbrSpecularGlossiness){this.defines.push("MATERIAL_SPECULARGLOSSINESS 1");let t=e.vec4.fromValues(1,1,1,1),i=e.vec3.fromValues(1,1,1),s=1;void 0!==this.extensions.KHR_materials_pbrSpecularGlossiness.diffuseFactor&&(t=r(this.extensions.KHR_materials_pbrSpecularGlossiness.diffuseFactor)),void 0!==this.extensions.KHR_materials_pbrSpecularGlossiness.specularFactor&&(i=r(this.extensions.KHR_materials_pbrSpecularGlossiness.specularFactor)),void 0!==this.extensions.KHR_materials_pbrSpecularGlossiness.glossinessFactor&&(s=this.extensions.KHR_materials_pbrSpecularGlossiness.glossinessFactor),this.properties.set("u_DiffuseFactor",t),this.properties.set("u_SpecularFactor",i),this.properties.set("u_GlossinessFactor",s)}if(void 0!==this.extensions.KHR_materials_clearcoat){let e=0,t=0;this.defines.push("MATERIAL_CLEARCOAT 1"),void 0!==this.extensions.KHR_materials_clearcoat.clearcoatFactor&&(e=this.extensions.KHR_materials_clearcoat.clearcoatFactor),void 0!==this.extensions.KHR_materials_clearcoat.clearcoatRoughnessFactor&&(t=this.extensions.KHR_materials_clearcoat.clearcoatRoughnessFactor),void 0!==this.clearcoatTexture&&(this.clearcoatTexture.samplerName="u_ClearcoatSampler",this.parseTextureInfoExtensions(this.clearcoatTexture,"Clearcoat"),this.textures.push(this.clearcoatTexture),this.defines.push("HAS_CLEARCOAT_TEXTURE_MAP 1"),this.properties.set("u_ClearcoatUVSet",this.clearcoatTexture.texCoord)),void 0!==this.clearcoatRoughnessTexture&&(this.clearcoatRoughnessTexture.samplerName="u_ClearcoatRoughnessSampler",this.parseTextureInfoExtensions(this.clearcoatRoughnessTexture,"ClearcoatRoughness"),this.textures.push(this.clearcoatRoughnessTexture),this.defines.push("HAS_CLEARCOAT_ROUGHNESS_MAP 1"),this.properties.set("u_ClearcoatRoughnessUVSet",this.clearcoatRoughnessTexture.texCoord)),void 0!==this.clearcoatNormalTexture&&(this.clearcoatNormalTexture.samplerName="u_ClearcoatNormalSampler",this.parseTextureInfoExtensions(this.clearcoatNormalTexture,"ClearcoatNormal"),this.textures.push(this.clearcoatNormalTexture),this.defines.push("HAS_CLEARCOAT_NORMAL_MAP 1"),this.properties.set("u_ClearcoatNormalUVSet",this.clearcoatNormalTexture.texCoord)),this.properties.set("u_ClearcoatFactor",e),this.properties.set("u_ClearcoatRoughnessFactor",t)}if(void 0!==this.extensions.KHR_materials_sheen){let t=0,i=e.vec3.fromValues(1,1,1);this.defines.push("MATERIAL_SHEEN 1"),void 0!==this.extensions.KHR_materials_sheen.sheenRoughnessFactor&&(t=this.extensions.KHR_materials_sheen.sheenRoughnessFactor),void 0!==this.extensions.KHR_materials_sheen.sheenColorFactor&&(i=r(this.extensions.KHR_materials_sheen.sheenColorFactor)),void 0!==this.sheenRoughnessTexture&&(this.sheenRoughnessTexture.samplerName="u_sheenRoughnessSampler",this.parseTextureInfoExtensions(this.sheenRoughnessTexture,"SheenRoughness"),this.textures.push(this.sheenRoughnessTexture),this.defines.push("HAS_SHEEN_ROUGHNESS_MAP 1"),this.properties.set("u_SheenRoughnessUVSet",this.sheenRoughnessTexture.texCoord)),void 0!==this.sheenColorTexture&&(this.sheenColorTexture.samplerName="u_SheenColorSampler",this.parseTextureInfoExtensions(this.sheenColorTexture,"SheenColor"),this.textures.push(this.sheenColorTexture),this.defines.push("HAS_SHEEN_COLOR_MAP 1"),this.properties.set("u_SheenColorUVSet",this.sheenColorTexture.texCoord)),this.properties.set("u_SheenRoughnessFactor",t),this.properties.set("u_SheenColorFactor",i)}if(void 0!==this.extensions.KHR_materials_transmission){let e=0;this.defines.push("MATERIAL_TRANSMISSION 1"),void 0!==e&&(e=this.extensions.KHR_materials_transmission.transmissionFactor),void 0!==this.transmissionTexture&&(this.transmissionTexture.samplerName="u_TransmissionSampler",this.parseTextureInfoExtensions(this.transmissionTexture,"Transmission"),this.textures.push(this.transmissionTexture),this.defines.push("HAS_TRANSMISSION_MAP 1"),this.properties.set("u_TransmissionUVSet",this.transmissionTexture.texCoord)),this.properties.set("u_TransmissionFactor",e)}}n(this,t,i)}fromJson(e){if(super.fromJson(e),void 0!==e.emissiveFactor&&(this.emissiveFactor=r(e.emissiveFactor)),void 0!==e.normalTexture){const t=new we;t.fromJson(e.normalTexture),this.normalTexture=t}if(void 0!==e.occlusionTexture){const t=new we;t.fromJson(e.occlusionTexture),this.occlusionTexture=t}if(void 0!==e.emissiveTexture){const t=new we(void 0,0,!1);t.fromJson(e.emissiveTexture),this.emissiveTexture=t}void 0!==e.extensions&&this.fromJsonMaterialExtensions(e.extensions),void 0!==e.pbrMetallicRoughness&&"SG"!==this.type&&(this.type="MR",this.fromJsonMetallicRoughness(e.pbrMetallicRoughness))}fromJsonMaterialExtensions(e){void 0!==e.KHR_materials_pbrSpecularGlossiness&&(this.type="SG",this.fromJsonSpecularGlossiness(e.KHR_materials_pbrSpecularGlossiness)),void 0!==e.KHR_materials_unlit&&(this.type="unlit"),void 0!==e.KHR_materials_clearcoat&&this.fromJsonClearcoat(e.KHR_materials_clearcoat),void 0!==e.KHR_materials_sheen&&this.fromJsonSheen(e.KHR_materials_sheen),void 0!==e.KHR_materials_transmission&&this.fromJsonTransmission(e.KHR_materials_transmission)}fromJsonMetallicRoughness(e){if(void 0!==e.baseColorTexture){const t=new we(void 0,0,!1);t.fromJson(e.baseColorTexture),this.baseColorTexture=t}if(void 0!==e.metallicRoughnessTexture){const t=new we;t.fromJson(e.metallicRoughnessTexture),this.metallicRoughnessTexture=t}}fromJsonSpecularGlossiness(e){if(void 0!==e.diffuseTexture){const t=new we(void 0,0,!1);t.fromJson(e.diffuseTexture),this.diffuseTexture=t}if(void 0!==e.specularGlossinessTexture){const t=new we;t.fromJson(e.specularGlossinessTexture),this.specularGlossinessTexture=t}}fromJsonClearcoat(e){if(void 0!==e.clearcoatTexture){const t=new we;t.fromJson(e.clearcoatTexture),this.clearcoatTexture=t}if(void 0!==e.clearcoatRoughnessTexture){const t=new we;t.fromJson(e.clearcoatRoughnessTexture),this.clearcoatRoughnessTexture=t}if(void 0!==e.clearcoatNormalTexture){const t=new we;t.fromJson(e.clearcoatNormalTexture),this.clearcoatNormalTexture=t}}fromJsonSheen(e){if(void 0!==e.sheenColorTexture){const t=new we;t.fromJson(e.sheenColorTexture),this.sheenColorTexture=t}if(void 0!==e.sheenRoughnessTexture){const t=new we;t.fromJson(e.sheenRoughnessTexture),this.sheenRoughnessTexture=t}}fromJsonTransmission(e){if(void 0!==e.transmissionTexture){const t=new we;t.fromJson(e.transmissionTexture),this.transmissionTexture=t}}}class Fe{constructor(e){if(!Fe.instance&&void 0===e){if(void 0===DracoDecoderModule)return void console.error("Failed to initalize DracoDecoder: draco library undefined");e=DracoDecoderModule}return Fe.instance||(Fe.instance=this,this.module=null,this.initializingPromise=new Promise((t=>{let i={};i.onModuleLoaded=e=>{this.module=e,t()},e(i)}))),Fe.instance}async ready(){await this.initializingPromise,Object.freeze(Fe.instance)}}class Oe extends g{constructor(){super(),this.attributes=[],this.targets=[],this.indices=void 0,this.material=void 0,this.mode=N.TRIANGLES,this.glAttributes=[],this.defines=[],this.skip=!0,this.hasWeights=!1,this.hasJoints=!1,this.hasNormals=!1,this.hasTangents=!1,this.hasTexcoord=!1,this.hasColor=!1,this.centroid=void 0}initGl(e,t){void 0===this.material&&(this.material=e.materials.length-1),n(this,e,t);const i=t.getParameter(N.MAX_VERTEX_ATTRIBS);if(void 0!==this.extensions&&void 0!==this.extensions.KHR_draco_mesh_compression){const t=new Fe;if(void 0!==t&&Object.isFrozen(t)){let t=this.decodeDracoBufferToIntermediate(this.extensions.KHR_draco_mesh_compression,e);this.copyDataFromDecodedGeometry(e,t,this.attributes)}else console.warn("Failed to load draco compressed mesh: DracoDecoder not initialized")}for(const t of Object.keys(this.attributes)){if(this.glAttributes.length>=i){console.error("To many vertex attributes for this primitive, skipping "+t);break}const r=this.attributes[t];switch(t){case"POSITION":this.skip=!1,this.glAttributes.push({attribute:t,name:"a_Position",accessor:r});break;case"NORMAL":this.hasNormals=!0,this.defines.push("HAS_NORMALS 1"),this.glAttributes.push({attribute:t,name:"a_Normal",accessor:r});break;case"TANGENT":this.hasTangents=!0,this.defines.push("HAS_TANGENTS 1"),this.glAttributes.push({attribute:t,name:"a_Tangent",accessor:r});break;case"TEXCOORD_0":this.hasTexcoord=!0,this.defines.push("HAS_UV_SET1 1"),this.glAttributes.push({attribute:t,name:"a_UV1",accessor:r});break;case"TEXCOORD_1":this.hasTexcoord=!0,this.defines.push("HAS_UV_SET2 1"),this.glAttributes.push({attribute:t,name:"a_UV2",accessor:r});break;case"COLOR_0":this.hasColor=!0;const i=e.accessors[r];this.defines.push("HAS_VERTEX_COLOR_"+i.type+" 1"),this.glAttributes.push({attribute:t,name:"a_Color",accessor:r});break;case"JOINTS_0":this.hasJoints=!0,this.defines.push("HAS_JOINT_SET1 1"),this.glAttributes.push({attribute:t,name:"a_Joint1",accessor:r});break;case"WEIGHTS_0":this.hasWeights=!0,this.defines.push("HAS_WEIGHT_SET1 1"),this.glAttributes.push({attribute:t,name:"a_Weight1",accessor:r});break;case"JOINTS_1":this.hasJoints=!0,this.defines.push("HAS_JOINT_SET2 1"),this.glAttributes.push({attribute:t,name:"a_Joint2",accessor:r});break;case"WEIGHTS_1":this.hasWeights=!0,this.defines.push("HAS_WEIGHT_SET2 1"),this.glAttributes.push({attribute:t,name:"a_Weight2",accessor:r});break;default:console.log("Unknown attribute: "+t)}}if(void 0!==this.targets){let e=0;for(const t of this.targets){if(this.glAttributes.length+3>i){console.error("To many vertex attributes for this primitive, skipping target "+e);break}for(const i of Object.keys(t)){const r=t[i];switch(i){case"POSITION":this.defines.push("HAS_TARGET_POSITION"+e+" 1"),this.glAttributes.push({attribute:i,name:"a_Target_Position"+e,accessor:r});break;case"NORMAL":this.defines.push("HAS_TARGET_NORMAL"+e+" 1"),this.glAttributes.push({attribute:i,name:"a_Target_Normal"+e,accessor:r});break;case"TANGENT":this.defines.push("HAS_TARGET_TANGENT"+e+" 1"),this.glAttributes.push({attribute:i,name:"a_Target_Tangent"+e,accessor:r})}}++e}}}getShaderIdentifier(){return"primitive.vert"}getDefines(){return this.defines}setCentroid(e){this.centroid=e}fromJson(e){super.fromJson(e),void 0!==e.extensions&&this.fromJsonPrimitiveExtensions(e.extensions)}fromJsonPrimitiveExtensions(e){void 0!==e.KHR_materials_variants&&this.fromJsonVariants(e.KHR_materials_variants)}fromJsonVariants(e){void 0!==e.mappings&&(this.mappings=e.mappings)}copyDataFromDecodedGeometry(e,t,i){let r=t.index.array;if(this.loadBufferIntoGltf(r,e,this.indices,34963,"index buffer view"),void 0!==t.attributes.POSITION){let r=this.loadArrayIntoArrayBuffer(t.attributes.POSITION.array,t.attributes.POSITION.componentType);this.loadBufferIntoGltf(r,e,i.POSITION,34962,"position buffer view")}if(void 0!==t.attributes.NORMAL){let r=this.loadArrayIntoArrayBuffer(t.attributes.NORMAL.array,t.attributes.NORMAL.componentType);this.loadBufferIntoGltf(r,e,i.NORMAL,34962,"normal buffer view")}if(void 0!==t.attributes.TEXCOORD_0){let r=this.loadArrayIntoArrayBuffer(t.attributes.TEXCOORD_0.array,t.attributes.TEXCOORD_0.componentType);this.loadBufferIntoGltf(r,e,i.TEXCOORD_0,34962,"TEXCOORD_0 buffer view")}if(void 0!==t.attributes.TEXCOORD_1){let r=this.loadArrayIntoArrayBuffer(t.attributes.TEXCOORD_1.array,t.attributes.TEXCOORD_1.componentType);this.loadBufferIntoGltf(r,e,i.TEXCOORD_1,34962,"TEXCOORD_1 buffer view")}if(void 0!==t.attributes.TANGENT){let r=this.loadArrayIntoArrayBuffer(t.attributes.TANGENT.array,t.attributes.TANGENT.componentType);this.loadBufferIntoGltf(r,e,i.TANGENT,34962,"Tangent buffer view")}if(void 0!==t.attributes.COLOR_0){let r=this.loadArrayIntoArrayBuffer(t.attributes.COLOR_0.array,t.attributes.COLOR_0.componentType);this.loadBufferIntoGltf(r,e,i.COLOR_0,34962,"color buffer view")}if(void 0!==t.attributes.JOINTS_0){let r=this.loadArrayIntoArrayBuffer(t.attributes.JOINTS_0.array,t.attributes.JOINTS_0.componentType);this.loadBufferIntoGltf(r,e,i.JOINTS_0,34963,"JOINTS_0 buffer view")}if(void 0!==t.attributes.WEIGHTS_0){let r=this.loadArrayIntoArrayBuffer(t.attributes.WEIGHTS_0.array,t.attributes.WEIGHTS_0.componentType);this.loadBufferIntoGltf(r,e,i.WEIGHTS_0,34963,"WEIGHTS_0 buffer view")}if(void 0!==t.attributes.JOINTS_1){let r=this.loadArrayIntoArrayBuffer(t.attributes.JOINTS_1.array,t.attributes.JOINTS_1.componentType);this.loadBufferIntoGltf(r,e,i.JOINTS_1,34963,"JOINTS_1 buffer view")}if(void 0!==t.attributes.WEIGHTS_1){let r=this.loadArrayIntoArrayBuffer(t.attributes.WEIGHTS_1.array,t.attributes.WEIGHTS_1.componentType);this.loadBufferIntoGltf(r,e,i.WEIGHTS_1,34963,"WEIGHTS_1 buffer view")}}loadBufferIntoGltf(e,t,i,r,s){const n=new Re;n.byteLength=e.byteLength,n.buffer=e,t.buffers.push(n);const o=new be;o.buffer=t.buffers.length-1,o.byteLength=e.byteLength,void 0!==s&&(o.name=s),o.target=r,t.bufferViews.push(o),t.accessors[i].byteOffset=0,t.accessors[i].bufferView=t.bufferViews.length-1}loadArrayIntoArrayBuffer(e,t){let i;switch(t){case"Int8Array":i=new ArrayBuffer(e.length),new Int8Array(i).set(e);break;case"Uint8Array":i=new ArrayBuffer(e.length),new Uint8Array(i).set(e);break;case"Int16Array":i=new ArrayBuffer(2*e.length),new Int16Array(i).set(e);break;case"Uint16Array":i=new ArrayBuffer(2*e.length),new Uint16Array(i).set(e);break;case"Int32Array":i=new ArrayBuffer(4*e.length),new Int32Array(i).set(e);break;case"Uint32Array":i=new ArrayBuffer(4*e.length),new Uint32Array(i).set(e);break;default:case"Float32Array":i=new ArrayBuffer(4*e.length),new Float32Array(i).set(e)}return i}decodeDracoBufferToIntermediate(e,t){let i=e.bufferView;const r=t.bufferViews[i],s=t.buffers[r.buffer],n=new Int8Array(s.buffer).slice(r.byteOffset,r.byteOffset+r.byteLength);let o=(new Fe).module,a=new o.Decoder,l=new o.DecoderBuffer;l.Init(n,r.byteLength);let c=this.decodeGeometry(o,a,l,e.attributes,t);return o.destroy(l),c}getDracoArrayTypeFromComponentType(e){switch(e){case N.BYTE:return"Int8Array";case N.UNSIGNED_BYTE:return"Uint8Array";case N.SHORT:return"Int16Array";case N.UNSIGNED_SHORT:return"Uint16Array";case N.INT:return"Int32Array";case N.UNSIGNED_INT:return"Uint32Array";case N.FLOAT:default:return"Float32Array"}}decodeGeometry(e,t,i,r,s){let n,o,a=t.GetEncodedGeometryType(i);if(a!==e.TRIANGULAR_MESH)throw new Error("DRACOLoader: Unexpected geometry type.");if(n=new e.Mesh,o=t.DecodeBufferToMesh(i,n),!o.ok()||0===n.ptr)throw new Error("DRACOLoader: Decoding failed: "+o.error_msg());let l={index:null,attributes:{}},c=n.num_points();for(let i in r){let o,a=N.BYTE;for(const[e,t]of Object.entries(this.attributes))if(e===i){a=s.accessors[t].componentType,o=s.accessors[t].count;break}if(c!==o)throw new Error(`DRACOLoader: Accessor vertex count ${o} does not match draco decoder vertex count  ${c}`);a=this.getDracoArrayTypeFromComponentType(a);let f=t.GetAttributeByUniqueId(n,r[i]);var u=this.decodeAttribute(e,t,n,i,f,a);l.attributes[u.name]=u}if(a===e.TRIANGULAR_MESH){let i=3*n.num_faces(),r=4*i,s=e._malloc(r);t.GetTrianglesUInt32Array(n,r,s);let o=new Uint32Array(e.HEAPU32.buffer,s,i).slice();e._free(s),l.index={array:o,itemSize:1}}return e.destroy(n),l}decodeAttribute(e,t,i,r,s,n){let o,a,l,c=s.num_components(),u=i.num_points()*c;switch(n){case"Float32Array":l=4*u,o=e._malloc(l),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_FLOAT32,l,o),a=new Float32Array(e.HEAPF32.buffer,o,u).slice(),e._free(o);break;case"Int8Array":o=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT8,u,o),a=new Int8Array(e.HEAP8.buffer,o,u).slice(),e._free(o);break;case"Int16Array":l=2*u,o=e._malloc(l),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT16,l,o),a=new Int16Array(e.HEAP16.buffer,o,u).slice(),e._free(o);break;case"Int32Array":l=4*u,o=e._malloc(l),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT32,l,o),a=new Int32Array(e.HEAP32.buffer,o,u).slice(),e._free(o);break;case"Uint8Array":o=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT8,u,o),a=new Uint8Array(e.HEAPU8.buffer,o,u).slice(),e._free(o);break;case"Uint16Array":l=2*u,o=e._malloc(l),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT16,l,o),a=new Uint16Array(e.HEAPU16.buffer,o,u).slice(),e._free(o);break;case"Uint32Array":l=4*u,o=e._malloc(l),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT32,l,o),a=new Uint32Array(e.HEAPU32.buffer,o,u).slice(),e._free(o);break;default:throw new Error("DRACOLoader: Unexpected attribute type.")}return{name:r,array:a,itemSize:c,componentType:n}}}class Pe extends g{constructor(){super(),this.primitives=[],this.name=void 0,this.weights=[]}fromJson(e){super.fromJson(e),void 0!==e.name&&(this.name=e.name),this.primitives=o(e.primitives,Oe),void 0!==e.weights&&(this.weights=e.weights)}}class Ve extends g{constructor(){super(),this.camera=void 0,this.children=[],this.matrix=void 0,this.rotation=r([0,0,0,1]),this.scale=r([1,1,1]),this.translation=r([0,0,0]),this.name=void 0,this.mesh=void 0,this.skin=void 0,this.worldTransform=e.mat4.create(),this.inverseWorldTransform=e.mat4.create(),this.normalMatrix=e.mat4.create(),this.light=void 0,this.changed=!0}initGl(){void 0!==this.matrix?this.applyMatrix(this.matrix):(void 0!==this.scale&&(this.scale=r(this.scale)),void 0!==this.rotation&&(this.rotation=r(this.rotation)),void 0!==this.translation&&(this.translation=r(this.translation))),this.changed=!0}applyMatrix(t){this.matrix=r(t),e.mat4.getScaling(this.scale,this.matrix);const i=e.mat4.create();for(const e of[0,1,2])i[e]=this.matrix[e]/this.scale[0],i[e+4]=this.matrix[e+4]/this.scale[1],i[e+8]=this.matrix[e+8]/this.scale[2];e.mat4.getRotation(this.rotation,i),e.quat.normalize(this.rotation,this.rotation),e.mat4.getTranslation(this.translation,this.matrix),this.changed=!0}applyTranslation(e){this.translation=e,this.changed=!0}applyRotation(e){this.rotation=e,this.changed=!0}applyScale(e){this.scale=e,this.changed=!0}resetTransform(){this.rotation=r([0,0,0,1]),this.scale=r([1,1,1]),this.translation=r([0,0,0]),this.changed=!0}getLocalTransform(){return(void 0===this.transform||this.changed)&&(this.transform=e.mat4.create(),e.mat4.fromRotationTranslationScale(this.transform,this.rotation,this.translation,this.scale),this.changed=!1),e.mat4.clone(this.transform)}}class He extends g{constructor(e=N.LINEAR,t=N.LINEAR_MIPMAP_LINEAR,i=N.REPEAT,r=N.REPEAT){super(),this.magFilter=e,this.minFilter=t,this.wrapS=i,this.wrapT=r,this.name=void 0}static createDefault(){return new He}}class De extends g{constructor(e=[],t){super(),this.nodes=e,this.name=t,this.imageBasedLight=void 0}initGl(e,t){if(super.initGl(e,t),void 0!==this.extensions&&void 0!==this.extensions.KHR_lights_image_based){const t=this.extensions.KHR_lights_image_based.imageBasedLight;this.imageBasedLight=e.imageBasedLights[t]}}applyTransformHierarchy(t,i=e.mat4.create()){function r(t,i,s){e.mat4.multiply(i.worldTransform,s,i.getLocalTransform()),e.mat4.invert(i.inverseWorldTransform,i.worldTransform),e.mat4.transpose(i.normalMatrix,i.inverseWorldTransform);for(const e of i.children)r(t,t.nodes[e],i.worldTransform)}for(const e of this.nodes)r(t,t.nodes[e],i)}gatherNodes(e){const t=[];function i(r){const s=e.nodes[r];t.push(s);for(const e of s.children)i(e)}for(const e of this.nodes)i(e);return t}includesNode(e,t){let i=[...this.nodes];for(;i.length>0;){const r=i.pop();if(r===t)return!0;i=i.concat(e.nodes[r].children)}return!1}}class Be extends g{constructor(){super(),this.copyright=void 0,this.generator=void 0,this.version=void 0,this.minVersion=void 0}}class ke extends g{constructor(){super(),this.target={node:void 0,path:void 0},this.sampler=void 0}}const Xe="translation",ze="rotation",We="scale",Je="weights";class je extends g{constructor(){super(),this.input=void 0,this.interpolation=void 0,this.output=void 0}}const Ke="LINEAR",qe="STEP",Ye="CUBICSPLINE";class Qe{constructor(){this.prevKey=0,this.prevT=0}slerpQuat(t,i,r){const s=e.quat.create(),n=e.quat.create();e.quat.normalize(s,t),e.quat.normalize(n,i);const o=e.quat.create();return e.quat.slerp(o,s,n,r),e.quat.normalize(o,o),o}step(t,i,r){const s=new e.glMatrix.ARRAY_TYPE(r);for(let e=0;e<r;++e)s[e]=i[t*r+e];return s}linear(t,i,r,s,n){const o=new e.glMatrix.ARRAY_TYPE(n);for(let e=0;e<n;++e)o[e]=r[t*n+e]*(1-s)+r[i*n+e]*s;return o}cubicSpline(t,i,r,s,n,o){const a=t*o*3,l=i*o*3,c=1*o,u=2*o,f=new e.glMatrix.ARRAY_TYPE(o),h=n**2,d=n**3;for(let e=0;e<o;++e){const t=r[a+e+c],i=s*r[l+e+0],o=s*r[a+e+u],m=r[l+e+c];f[e]=(2*d-3*h+1)*t+(d-2*h+n)*o+(-2*d+3*h)*m+(d-h)*i}return f}resetKey(){this.prevKey=0}interpolate(t,i,r,n,o,a){const l=t.accessors[r.input].getDeinterlacedView(t),c=t.accessors[r.output].getDeinterlacedView(t);if(c.length===o)return s(c,0,o);n=u(n%=a,l[0],l[l.length-1]),this.prevT>n&&(this.prevKey=0),this.prevT=n;let f=null;for(let e=this.prevKey;e<l.length;++e)if(n<=l[e]){f=u(e,1,l.length-1);break}this.prevKey=u(f-1,0,f);const h=l[f]-l[this.prevKey],d=(n-l[this.prevKey])/h;if(i.target.path===ze){if(Ye===r.interpolation){const t=this.cubicSpline(this.prevKey,f,c,h,d,4);return e.quat.normalize(t,t),t}if(r.interpolation===Ke){const e=this.getQuat(c,this.prevKey),t=this.getQuat(c,f);return this.slerpQuat(e,t,d)}if(r.interpolation===qe)return this.getQuat(c,this.prevKey)}switch(r.interpolation){case qe:return this.step(this.prevKey,c,o);case Ye:return this.cubicSpline(this.prevKey,f,c,h,d,o);default:return this.linear(this.prevKey,f,c,d,o)}}getQuat(t,i){const r=t[4*i],s=t[4*i+1],n=t[4*i+2],o=t[4*i+3];return e.quat.fromValues(r,s,n,o)}}class Ze extends g{constructor(){super(),this.channels=[],this.samplers=[],this.name="",this.interpolators=[],this.maxTime=0}fromJson(e){if(super.fromJson(e),this.channels=o(e.channels,ke),this.samplers=o(e.samplers,je),this.name=e.name,void 0!==this.channels)for(let e=0;e<this.channels.length;++e)this.interpolators.push(new Qe);else console.error("No channel data found for skin")}advance(e,t){if(void 0!==this.channels){if(0==this.maxTime)for(let t=0;t<this.channels.length;++t){const i=this.channels[t],r=this.samplers[i.sampler],s=e.accessors[r.input].getDeinterlacedView(e),n=s[s.length-1];n>this.maxTime&&(this.maxTime=n)}for(let i=0;i<this.interpolators.length;++i){const r=this.channels[i],s=this.samplers[r.sampler],n=this.interpolators[i],o=e.nodes[r.target.node];switch(r.target.path){case Xe:o.applyTranslation(n.interpolate(e,r,s,t,3,this.maxTime));break;case ze:o.applyRotation(n.interpolate(e,r,s,t,4,this.maxTime));break;case We:o.applyScale(n.interpolate(e,r,s,t,3,this.maxTime));break;case Je:{const i=e.meshes[o.mesh];i.weights=n.interpolate(e,r,s,t,i.weights.length,this.maxTime);break}}}}}}class $e extends g{constructor(){super(),this.name="",this.inverseBindMatrices=void 0,this.joints=[],this.skeleton=void 0,this.jointMatrices=[],this.jointNormalMatrices=[]}computeJoints(t,i){const r=t.accessors[this.inverseBindMatrices].getDeinterlacedView(t);this.jointMatrices=[],this.jointNormalMatrices=[];let n=0;for(const o of this.joints){const a=t.nodes[o];let l=e.mat4.create(),c=s(r,16*n++,16);e.mat4.mul(l,a.worldTransform,c),e.mat4.mul(l,i.inverseWorldTransform,l),this.jointMatrices.push(l);let u=e.mat4.create();e.mat4.invert(u,l),e.mat4.transpose(u,u),this.jointNormalMatrices.push(u)}}}class et extends g{constructor(){super(),this.name=void 0}fromJson(e){void 0!==e.name&&(this.name=e.name)}}class tt extends g{constructor(e){super(),this.asset=void 0,this.accessors=[],this.nodes=[],this.scene=void 0,this.scenes=[],this.cameras=[],this.lights=[],this.imageBasedLights=[],this.textures=[],this.images=[],this.samplers=[],this.meshes=[],this.buffers=[],this.bufferViews=[],this.materials=[],this.animations=[],this.skins=[],this.path=e}initGl(e){n(this,this,e)}fromJson(e){super.fromJson(e),this.asset=a(e.asset,Be),this.cameras=o(e.cameras,_),this.accessors=o(e.accessors,xe),this.meshes=o(e.meshes,Pe),this.samplers=o(e.samplers,He),this.materials=o(e.materials,Ge),this.buffers=o(e.buffers,Re),this.bufferViews=o(e.bufferViews,be),this.scenes=o(e.scenes,De),this.textures=o(e.textures,Me),this.nodes=o(e.nodes,Ve),this.lights=o(function(e){if(void 0===e)return[];if(void 0===e.KHR_lights_punctual)return[];return e.KHR_lights_punctual.lights}(e.extensions),Ce),this.imageBasedLights=o(function(e){if(void 0===e)return[];if(void 0===e.KHR_lights_image_based)return[];return e.KHR_lights_image_based.imageBasedLights}(e.extensions),Le),this.images=o(e.images,U),this.animations=o(e.animations,Ze),this.skins=o(e.skins,$e),this.variants=o(function(e){if(void 0===e)return[];if(void 0===e.KHR_materials_variants)return[];return e.KHR_materials_variants.variants}(e.extensions),et),this.variants=function(e){for(let t=0;t<e.length;t++){const i=e[t].name;for(let r=t+1;r<e.length;r++)e[r].name==i&&(e[r].name+="0")}return e}(this.variants),this.materials.push(Ge.createDefault()),this.samplers.push(He.createDefault()),void 0!==e.scenes&&(void 0===e.scene&&e.scenes.length>0?this.scene=0:this.scene=e.scene)}}class it{constructor(e){this.data=e,this.glbHeaderInts=3,this.glbChunkHeaderInts=2,this.glbMagic=1179937895,this.glbVersion=2,this.jsonChunkType=1313821514,this.binaryChunkType=5130562}extractGlbData(){if(void 0===this.getCheckedGlbInfo())return;let e,t=[];const i=this.getAllChunkInfos();for(let r of i)r.type!=this.jsonChunkType||e?r.type==this.binaryChunkType&&t.push(this.getBufferFromChunk(r)):e=this.getJsonFromChunk(r);return{json:e,buffers:t}}getCheckedGlbInfo(){const e=new Uint32Array(this.data,0,this.glbHeaderInts),t=e[0],i=e[1],r=e[2];if(this.checkEquality(t,this.glbMagic,"glb magic")&&this.checkEquality(i,this.glbVersion,"glb header version")&&this.checkEquality(r,this.data.byteLength,"glb byte length"))return{magic:t,version:i,length:r}}getAllChunkInfos(){let e=[],t=4*this.glbHeaderInts;for(;t<this.data.byteLength;){const i=this.getChunkInfo(t);e.push(i),t+=i.length+4*this.glbChunkHeaderInts}return e}getChunkInfo(e){const t=new Uint32Array(this.data,e,this.glbChunkHeaderInts);return{start:e+4*this.glbChunkHeaderInts,length:t[0],type:t[1]}}getJsonFromChunk(e){const t=e.length,i=4*(this.glbHeaderInts+this.glbChunkHeaderInts),r=new Uint8Array(this.data,i,t),s=new TextDecoder("utf-8").decode(r);return JSON.parse(s)}getBufferFromChunk(e){return this.data.slice(e.start,e.start+e.length)}checkEquality(e,t,i){return e==t||(console.error("Found invalid/unsupported "+i+", expected: "+t+", but was: "+e),!1)}}class rt{static async load(e,t,i){const r=rt.getBuffers(i),s=rt.getAdditionalFiles(i),n=rt.loadBuffers(e,r,s);await n;const o=rt.loadImages(e,s);return await Promise.all([n,o]).then((()=>e.initGl(t)))}static unload(e){for(let t of e.images)t.image=void 0;e.images=[];for(let t of e.textures)t.destroy();e.textures=[];for(let t of e.accessors)t.destroy();e.accessors=[]}static getBuffers(e){return rt.getTypedAppendix(e,ArrayBuffer)}static getAdditionalFiles(e){return"undefined"!=typeof File?rt.getTypedAppendix(e,File):void 0}static getTypedAppendix(e,t){if(e&&e.length>0&&e[0]instanceof t)return e}static loadBuffers(e,t,i){const r=[];if(t){const i=Math.min(t.length,e.buffers.length);for(let r=0;r<i;++r)e.buffers[r].buffer=t[r]}else for(const t of e.buffers)r.push(t.load(e,i));return Promise.all(r)}static loadImages(e,t){const i=[];for(let r of e.images)i.push(r.load(e,t));return Promise.all(i)}}class st{constructor(e){this.gl=e.context,this.textureSize=256,this.sampleCount=64,this.lodBias=0,this.mipmapCount=void 0,this.lambertianTextureID=void 0,this.ggxTextureID=void 0,this.sheenTextureID=void 0,this.inputTextureID=void 0,this.cubemapTextureID=void 0,this.framebuffer=void 0;const t=new Map;t.set("fullscreen.vert","precision highp float;\n#define GLSLIFY 1\nout vec2 texCoord;void main(void){float x=float((gl_VertexID&1)<<2);float y=float((gl_VertexID&2)<<1);texCoord.x=x*0.5;texCoord.y=y*0.5;gl_Position=vec4(x-1.0,y-1.0,0,1);}"),t.set("panorama_to_cubemap.frag","#define MATH_PI 3.1415926535897932384626433832795\n#define MATH_INV_PI (1.0 / MATH_PI)\nprecision highp float;\n#define GLSLIFY 1\nin vec2 texCoord;out vec4 fragmentColor;uniform int u_currentFace;uniform sampler2D u_inputTexture;uniform sampler2D u_panorama;vec3 uvToXYZ(int face,vec2 uv){if(face==0)return vec3(1.f,uv.y,-uv.x);else if(face==1)return vec3(-1.f,uv.y,uv.x);else if(face==2)return vec3(+uv.x,-1.f,+uv.y);else if(face==3)return vec3(+uv.x,1.f,-uv.y);else if(face==4)return vec3(+uv.x,uv.y,1.f);else{return vec3(-uv.x,+uv.y,-1.f);}}vec2 dirToUV(vec3 dir){return vec2(0.5f+0.5f*atan(dir.z,dir.x)/MATH_PI,1.f-acos(dir.y)/MATH_PI);}vec3 panoramaToCubeMap(int face,vec2 texCoord){vec2 texCoordNew=texCoord*2.0-1.0;vec3 scan=uvToXYZ(face,texCoordNew);vec3 direction=normalize(scan);vec2 src=dirToUV(direction);return texture(u_panorama,src).rgb;}void main(void){fragmentColor=vec4(0.0,0.0,0.0,1.0);fragmentColor.rgb=panoramaToCubeMap(u_currentFace,texCoord);}"),t.set("ibl_filtering.frag","precision mediump float;\n#define GLSLIFY 1\n#define MATH_PI 3.1415926535897932384626433832795\nuniform samplerCube uCubeMap;const int cLambertian=0;const int cGGX=1;const int cCharlie=2;uniform float u_roughness;uniform int u_sampleCount;uniform int u_width;uniform float u_lodBias;uniform int u_distribution;uniform int u_currentFace;in vec2 texCoord;out vec4 fragmentColor;vec3 uvToXYZ(int face,vec2 uv){if(face==0)return vec3(1.f,uv.y,-uv.x);else if(face==1)return vec3(-1.f,uv.y,uv.x);else if(face==2)return vec3(+uv.x,-1.f,+uv.y);else if(face==3)return vec3(+uv.x,1.f,-uv.y);else if(face==4)return vec3(+uv.x,uv.y,1.f);else{return vec3(-uv.x,+uv.y,-1.f);}}vec2 dirToUV(vec3 dir){return vec2(0.5f+0.5f*atan(dir.z,dir.x)/MATH_PI,1.f-acos(dir.y)/MATH_PI);}float saturate(float v){return clamp(v,0.0f,1.0f);}float bitfieldReverse(uint bits){bits=(bits<<16u)|(bits>>16u);bits=((bits&0x55555555u)<<1u)|((bits&0xAAAAAAAAu)>>1u);bits=((bits&0x33333333u)<<2u)|((bits&0xCCCCCCCCu)>>2u);bits=((bits&0x0F0F0F0Fu)<<4u)|((bits&0xF0F0F0F0u)>>4u);bits=((bits&0x00FF00FFu)<<8u)|((bits&0xFF00FF00u)>>8u);return float(bits);}float Hammersley(uint i){return bitfieldReverse(i)*2.3283064365386963e-10;}vec3 getImportanceSampleDirection(vec3 normal,float sinTheta,float cosTheta,float phi){vec3 H=normalize(vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta));vec3 bitangent=vec3(0.0,1.0,0.0);float NdotX=dot(normal,vec3(1.0,0.0,0.0));float NdotY=dot(normal,vec3(0.0,1.0,0.0));float NdotZ=dot(normal,vec3(0.0,0.0,1.0));if(abs(NdotY)>abs(NdotX)&&abs(NdotY)>abs(NdotZ)){if(NdotY>0.0){bitangent=vec3(0.0,0.0,1.0);}else{bitangent=vec3(0.0,0.0,-1.0);}}vec3 tangent=cross(bitangent,normal);bitangent=cross(normal,tangent);return normalize(tangent*H.x+bitangent*H.y+normal*H.z);}float V_Ashikhmin(float NdotL,float NdotV){return clamp(1.0/(4.0*(NdotL+NdotV-NdotL*NdotV)),0.0,1.0);}float D_GGX(float NdotH,float roughness){float alpha=roughness*roughness;float alpha2=alpha*alpha;float divisor=NdotH*NdotH*(alpha2-1.0)+1.0;return alpha2/(MATH_PI*divisor*divisor);}float D_Ashikhmin(float NdotH,float roughness){float alpha=roughness*roughness;float a2=alpha*alpha;float cos2h=NdotH*NdotH;float sin2h=1.0-cos2h;float sin4h=sin2h*sin2h;float cot2=-cos2h/(a2*sin2h);return 1.0/(MATH_PI*(4.0*a2+1.0)*sin4h)*(4.0*exp(cot2)+sin4h);}float D_Charlie(float sheenRoughness,float NdotH){sheenRoughness=max(sheenRoughness,0.000001);float alphaG=sheenRoughness*sheenRoughness;float invR=1.0/alphaG;float cos2h=NdotH*NdotH;float sin2h=1.0-cos2h;return(2.0+invR)*pow(sin2h,invR*0.5)/(2.0*MATH_PI);}vec3 getSampleVector(int sampleIndex,vec3 N,float roughness){float X=float(sampleIndex)/float(u_sampleCount);float Y=Hammersley(uint(sampleIndex));float phi=2.0*MATH_PI*X;float cosTheta=0.f;float sinTheta=0.f;if(u_distribution==cLambertian){cosTheta=1.0-Y;sinTheta=sqrt(1.0-cosTheta*cosTheta);}else if(u_distribution==cGGX){float alpha=roughness*roughness;cosTheta=sqrt((1.0-Y)/(1.0+(alpha*alpha-1.0)*Y));sinTheta=sqrt(1.0-cosTheta*cosTheta);}else if(u_distribution==cCharlie){float alpha=roughness*roughness;sinTheta=pow(Y,alpha/(2.0*alpha+1.0));cosTheta=sqrt(1.0-sinTheta*sinTheta);}return getImportanceSampleDirection(N,sinTheta,cosTheta,phi);}float PDF(vec3 V,vec3 H,vec3 N,vec3 L,float roughness){if(u_distribution==cLambertian){float NdotL=dot(N,L);return max(NdotL*(1.0/MATH_PI),0.0);}else if(u_distribution==cGGX){float VdotH=dot(V,H);float NdotH=dot(N,H);float D=D_GGX(NdotH,roughness);return max(D*NdotH/(4.0*VdotH),0.0);}else if(u_distribution==cCharlie){float VdotH=dot(V,H);float NdotH=dot(N,H);float D=D_Charlie(roughness,NdotH);return max(D*NdotH/abs(4.0*VdotH),0.0);}return 0.f;}vec3 filterColor(vec3 N){vec4 color=vec4(0.f);float solidAngleTexel=4.0*MATH_PI/(6.0*float(u_width)*float(u_width));for(int i=0;i<u_sampleCount;++i){vec3 H=getSampleVector(i,N,u_roughness);vec3 V=N;vec3 L=normalize(reflect(-V,H));float NdotL=dot(N,L);if(NdotL>0.0){float lod=0.0;if(u_roughness>0.0||u_distribution==cLambertian){float pdf=PDF(V,H,N,L,u_roughness);float solidAngleSample=1.0/(float(u_sampleCount)*pdf);lod=0.5*log2(solidAngleSample/solidAngleTexel);lod+=u_lodBias;}if(u_distribution==cLambertian){color+=vec4(textureLod(uCubeMap,H,lod).rgb,1.0);}else{color+=vec4(textureLod(uCubeMap,L,lod).rgb*NdotL,NdotL);}}}if(color.w==0.f){return color.rgb;}return color.rgb/color.w;}float V_SmithGGXCorrelated(float NoV,float NoL,float roughness){float a2=pow(roughness,4.0);float GGXV=NoL*sqrt(NoV*NoV*(1.0-a2)+a2);float GGXL=NoV*sqrt(NoL*NoL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}vec3 LUT(float NdotV,float roughness){vec3 V=vec3(sqrt(1.0-NdotV*NdotV),0.0,NdotV);vec3 N=vec3(0.0,0.0,1.0);float A=0.0;float B=0.0;float C=0.0;for(int i=0;i<u_sampleCount;++i){vec3 H=getSampleVector(i,N,roughness);vec3 L=normalize(reflect(-V,H));float NdotL=saturate(L.z);float NdotH=saturate(H.z);float VdotH=saturate(dot(V,H));if(NdotL>0.0){if(u_distribution==cGGX){float V_pdf=V_SmithGGXCorrelated(NdotV,NdotL,roughness)*VdotH*NdotL/NdotH;float Fc=pow(1.0-VdotH,5.0);A+=(1.0-Fc)*V_pdf;B+=Fc*V_pdf;C+=0.0;}if(u_distribution==cCharlie){float sheenDistribution=D_Charlie(roughness,NdotH);float sheenVisibility=V_Ashikhmin(NdotL,NdotV);A+=0.0;B+=0.0;C+=sheenVisibility*sheenDistribution*NdotL*VdotH;}}}return vec3(4.0*A,4.0*B,4.0*2.0*MATH_PI*C)/float(u_sampleCount);}void main(){vec2 newUV=texCoord;newUV=newUV*2.0-1.0;vec3 scan=uvToXYZ(u_currentFace,newUV);vec3 direction=normalize(scan);direction.y=-direction.y;vec3 color=filterColor(direction);fragmentColor=vec4(color,1.0);}"),t.set("debug.frag","precision highp float;\n#define GLSLIFY 1\nin vec2 texCoord;out vec4 fragmentColor;uniform int u_currentFace;uniform samplerCube u_inputTexture;vec3 uvToXYZ(int face,vec2 uv){if(face==0)return vec3(1.f,uv.y,-uv.x);else if(face==1)return vec3(-1.f,uv.y,uv.x);else if(face==2)return vec3(+uv.x,-1.f,+uv.y);else if(face==3)return vec3(+uv.x,1.f,-uv.y);else if(face==4)return vec3(+uv.x,uv.y,1.f);else{return vec3(-uv.x,+uv.y,-1.f);}}void main(void){fragmentColor=vec4(texCoord.x*10.0,0.0,texCoord.y*10.0,1.0);vec2 newUV=texCoord;newUV=newUV*2.0-1.0;vec4 textureColor=vec4(0.0,0.0,0.0,1.0);vec3 direction=normalize(uvToXYZ(u_currentFace,newUV.xy));textureColor=textureLod(u_inputTexture,direction,1.0);if(texCoord.x>0.1){fragmentColor=textureColor;}if(texCoord.y>0.1){fragmentColor=textureColor;}}"),this.shaderCache=new G(t,e.renderer.webGl)}loadTextureHDR(e){var t=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,t);var i=this.gl.RGB32F,r=this.gl.RGB,s=this.gl.FLOAT,n=void 0;if(e.dataFloat instanceof Float32Array&&void 0!==this.gl.RGB32F)i=this.gl.RGB32F,r=this.gl.RGB,s=this.gl.FLOAT,n=e.dataFloat;else if(e.dataFloat instanceof Float32Array){i=this.gl.RGBA32F,r=this.gl.RGBA,s=this.gl.FLOAT;const t=e.dataFloat.length/3;n=new Float32Array(4*t);for(let i=0;i<t;++i)n[i]=e.dataFloat[i],n[i+1]=e.dataFloat[i+1],n[i+2]=e.dataFloat[i+2],n[i+3]=0}else{if(!("undefined"!=typeof Image&&e instanceof Image))return void console.error("loadTextureHDR failed, unsupported HDR image");i=this.gl.RGBA,r=this.gl.RGBA,s=this.gl.UNSIGNED_BYTE,n=e}return this.gl.texImage2D(this.gl.TEXTURE_2D,0,i,e.width,e.height,0,r,s,n),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.MIRRORED_REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.MIRRORED_REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),t}createCubemapTexture(e){var t=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t);const i=this.use8bit?this.gl.RGBA8:this.gl.RGBA32F,r=this.gl.RGBA,s=this.use8bit?this.gl.UNSIGNED_BYTE:this.gl.FLOAT;for(var n=0;n<6;++n)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,i,this.textureSize,this.textureSize,0,r,s,null);return e?this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR):this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),t}init(e){this.gl.getExtension("EXT_color_buffer_float")||(this.use8bit=!0),this.inputTextureID=this.loadTextureHDR(e),this.cubemapTextureID=this.createCubemapTexture(!0),this.framebuffer=this.gl.createFramebuffer(),this.lambertianTextureID=this.createCubemapTexture(!1),this.ggxTextureID=this.createCubemapTexture(!0),this.sheenTextureID=this.createCubemapTexture(!0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.ggxTextureID),this.gl.generateMipmap(this.gl.TEXTURE_CUBE_MAP),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.sheenTextureID),this.gl.generateMipmap(this.gl.TEXTURE_CUBE_MAP),this.mipmapLevels=Math.floor(Math.log2(this.textureSize))+1}filterAll(){this.panoramaToCubeMap(),this.cubeMapToLambertian(),this.cubeMapToGGX(),this.cubeMapToSheen(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}panoramaToCubeMap(){for(var e=0;e<6;++e){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer);var t=e;this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.cubemapTextureID,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.cubemapTextureID),this.gl.viewport(0,0,this.textureSize,this.textureSize),this.gl.clearColor(1,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);const r=this.shaderCache.selectShader("fullscreen.vert",[]),s=this.shaderCache.selectShader("panorama_to_cubemap.frag",[]);var i=this.shaderCache.getShaderProgram(s,r);this.gl.useProgram(i.program),this.gl.activeTexture(this.gl.TEXTURE0+0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.inputTextureID);const n=this.gl.getUniformLocation(i.program,"u_panorama");this.gl.uniform1i(n,this.gl.TEXTURE0+0),i.updateUniform("u_currentFace",e),this.gl.drawArrays(this.gl.TRIANGLES,0,3)}this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.cubemapTextureID),this.gl.generateMipmap(this.gl.TEXTURE_CUBE_MAP)}applyFilter(e,t,i,r){for(var s=this.textureSize>>i,n=0;n<6;++n){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer);var o=n;this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+o,r,i),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,r),this.gl.viewport(0,0,s,s),this.gl.clearColor(1,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);const l=this.shaderCache.selectShader("fullscreen.vert",[]),c=this.shaderCache.selectShader("ibl_filtering.frag",[]);var a=this.shaderCache.getShaderProgram(c,l);this.gl.useProgram(a.program),this.gl.activeTexture(this.gl.TEXTURE0+0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.cubemapTextureID);const u=this.gl.getUniformLocation(a.program,"u_cubemapTexture");this.gl.uniform1i(u,0),a.updateUniform("u_roughness",t),a.updateUniform("u_sampleCount",this.sampleCount),a.updateUniform("u_width",this.textureSize),a.updateUniform("u_lodBias",this.lodBias),a.updateUniform("u_distribution",e),a.updateUniform("u_currentFace",n),this.gl.drawArrays(this.gl.TRIANGLES,0,3)}}cubeMapToLambertian(){this.applyFilter(0,0,0,this.lambertianTextureID)}cubeMapToGGX(){for(var e=0;e<this.mipmapLevels;++e){const t=e/(this.mipmapLevels-1);this.applyFilter(1,t,e,this.ggxTextureID)}}cubeMapToSheen(){for(var e=0;e<this.mipmapLevels;++e){const t=e/(this.mipmapLevels-1);this.applyFilter(2,t,e,this.sheenTextureID)}}destroy(){this.shaderCache.destroy()}}class nt{constructor(e,t){this.gl=e,this.libktx=null,void 0!==e?(void 0===t&&void 0!==LIBKTX&&(t=LIBKTX),void 0!==t?this.initializied=this.init(e,t):console.error("Failed to initalize KTXDecoder: ktx library undefined")):console.error("Failed to initalize KTXDecoder: WebGL context undefined")}async init(e,t){this.libktx=await t({preinitializedWebGLContext:e}),this.libktx.GL.makeContextCurrent(this.libktx.GL.createContext(null,{majorVersion:2}))}transcode(e){if(e.needsTranscoding){let t,i=!1,r=!1,s=!1,n=!1;i=!!this.gl.getExtension("WEBGL_compressed_texture_astc"),r=!!this.gl.getExtension("WEBGL_compressed_texture_etc1"),s=!!this.gl.getExtension("WEBGL_compressed_texture_s3tc"),n=!!this.gl.getExtension("WEBGL_compressed_texture_pvrtc")||!!this.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),t=i?this.libktx.TranscodeTarget.ASTC_4x4_RGBA:s?this.libktx.TranscodeTarget.BC1_OR_3:n?this.libktx.TranscodeTarget.PVRTC1_4_RGBA:r?this.libktx.TranscodeTarget.ETC:this.libktx.TranscodeTarget.RGBA8888,e.transcodeBasis(t,0)!=this.libktx.ErrorCode.SUCCESS&&console.warn("Texture transcode failed. See console for details.")}}async loadKtxFromUri(e){await this.initializied;const t=await fetch(e),i=new Uint8Array(await t.arrayBuffer()),r=new this.libktx.ktxTexture(i);this.transcode(r);let s=r.glUpload();return s.texture.levels=Math.log2(r.baseWidth),s.texture}async loadKtxFromBuffer(e){await this.initializied;const t=new this.libktx.ktxTexture(e);this.transcode(t);return t.glUpload().texture}}async function ot(e){let t="",i=0;const r=e;let s;for(;!t.match(/\n\n[^\n]+\n/g);)t+=String.fromCharCode(r[i++]);if(s=t.match(/FORMAT=(.*)$/m)[1],"32-bit_rle_rgbe"!=s)return console.warn("unknown format : "+s),this.onerror();const n=t.split(/\n/).reverse()[1].split(" "),o=1*n[3],a=1*n[1],l=new Uint8Array(o*a*4);let c=0;for(let e=0;e<a;e++){const e=[],t=r.slice(i,i+=4);if(2==t[0]&&2==t[1]&&t[2]==(o>>8&255)&&t[3]==(255&o)&&o>=8&&o<32768){for(let t=0;t<4;t++){let s=t*o;const n=(t+1)*o;let a,l;for(;s<n;)if(a=r.slice(i,i+=2),a[0]>128)for(l=a[0]-128;l-- >0;)e[s++]=a[1];else for(l=a[0]-1,e[s++]=a[1];l-- >0;)e[s++]=r[i++]}for(let t=0;t<o;t++)l[c++]=e[t+0*o],l[c++]=e[t+1*o],l[c++]=e[t+2*o],l[c++]=e[t+3*o]}else{i-=4;for(const e=0;e<o;e++)t=r.slice(i,i+=4),l[c++]=t[0],l[c++]=t[1],l[c++]=t[2],l[c++]=t[3]}}return{dataFloat:function(e){const t=e.byteLength>>2,i=new Float32Array(3*t);for(let r=0;r<t;r++){const t=Math.pow(2,e[4*r+3]-136);i[3*r]=e[4*r]*t,i[3*r+1]=e[4*r+1]*t,i[3*r+2]=e[4*r+2]*t}return i}(l),width:o,height:a}}exports.DebugOutput=L,exports.GltfView=class{constructor(e,t){this.ui=t,this.context=e,this.renderer=new F(this.context)}createState(){return new M}updateCanvas(e){void 0!==this.ui?e.width=window.innerWidth-this.ui.getBoundingClientRect().width:e.width=e.clientWidth,e.height=e.clientHeight}updateViewport(e,t){this.renderer.resize(e,t)}renderFrame(e){if(this.renderer.clearFrame(e.renderingParameters.clearColor),void 0===e.gltf)return;const t=e.gltf.scenes[e.sceneIndex];t.applyTransformHierarchy(e.gltf),this.renderer.drawScene(e,t)}animate(e){if(void 0!==e.gltf&&void 0!==e.gltf.animations&&void 0!==e.animationIndices&&!e.animationTimer.paused){const t=e.animationTimer.elapsedSec(),i=e.animationIndices.map((t=>e.gltf.animations[t])).filter((e=>void 0!==e));for(const r of i)r.advance(e.gltf,t)}}gatherStatistics(e){if(void 0===e.gltf)return;const t=e.gltf.scenes[e.sceneIndex].gatherNodes(e.gltf).filter((e=>void 0!==e.mesh)).map((t=>e.gltf.meshes[t.mesh])),i=t.reduce(((e,t)=>e.concat(t.primitives)),[]).filter((e=>void 0!==e.material)),r=[...new Set(i.map((t=>e.gltf.materials[t.material])))],s=r.filter((e=>"BLEND"!==e.alphaMode)),n=r.filter((e=>"BLEND"===e.alphaMode)),o=i.map((t=>{const i=e.gltf.accessors[t.indices].count;if(0===i)return 0;switch(t.mode){case N.POINTS:return i;case N.LINES:return i/2;case N.LINE_LOOP:return i;case N.LINE_STRIP:return i-1;case N.TRIANGLES:return i/3;case N.TRIANGLE_STRIP:case N.TRIANGLE_FAN:return i-2}})).reduce(((e,t)=>e+t));return{meshCount:t.length,faceCount:o,opaqueMaterialsCount:s.length,transparentMaterialsCount:n.length}}async startRendering(e,t){const i=()=>{this.animate(e),this.updateCanvas(t),this.updateViewport(t.width,t.height),this.renderFrame(e),window.requestAnimationFrame(i)};window.requestAnimationFrame(i)}},exports.ToneMaps=y,exports.combinePaths=function(){const e=Array.from(arguments);return e.join("/")},exports.computePrimitiveCentroids=function(e){const t=e.nodes.filter((e=>void 0!==e.mesh)).map((t=>e.meshes[t.mesh])).reduce(((e,t)=>e.concat(t.primitives)),[]);for(const i of t){const t=e.accessors[i.attributes.POSITION].getTypedView(e);if(void 0!==i.indices){const r=e.accessors[i.indices].getTypedView(e),s=new Float32Array(3);for(let e=0;e<r.length;e++){const i=3*r[e];s[0]+=t[i],s[1]+=t[i+1],s[2]+=t[i+2]}const n=new Float32Array([s[0]/r.length,s[1]/r.length,s[2]/r.length]);i.setCentroid(n)}else{const e=new Float32Array(3);for(let i=0;i<t.length;i+=3)e[0]+=t[i],e[1]+=t[i+1],e[2]+=t[i+2];const r=t.length/3,s=new Float32Array([e[0]/r,e[1]/r,e[2]/r]);i.setCentroid(s)}}},exports.getContainingFolder=d,exports.getFileNameWithoutExtension=function(e){const t=function(e){const t=e.split("/");return t[t.length-1]}(e),i=t.lastIndexOf(".");return t.slice(0,i)},exports.getIsGlb=f,exports.getIsGltf=function(e){return"gltf"==h(e)},exports.getIsHdr=function(e){return"hdr"==h(e)},exports.glTF=tt,exports.initDracoLib=async function(e){const t=new Fe(e);void 0!==t&&await t.ready()},exports.initKtxLib=function(e,t){e.ktxDecoder=new nt(e.context,t)},exports.loadEnvironment=async function(e,t){let i;if("string"==typeof e){let t=await Ae.get(e,{responseType:"arraybuffer"});i=await ot(new Uint8Array(t.data))}else if(e instanceof ArrayBuffer)i=await ot(new Uint8Array(e));else{const t=await x.readAsArrayBuffer(e).catch((()=>{console.error("Could not load image with FileReader")}));i=await ot(new Uint8Array(t))}return async function(e,t){const i=new tt;let r=i.samplers.length;i.samplers.push(new He(N.LINEAR,N.LINEAR,N.CLAMP_TO_EDGE,N.CLAMP_TO_EDGE,"DiffuseCubeMapSampler"));const s=r++;i.samplers.push(new He(N.LINEAR,N.LINEAR_MIPMAP_LINEAR,N.CLAMP_TO_EDGE,N.CLAMP_TO_EDGE,"SpecularCubeMapSampler"));const n=r++;i.samplers.push(new He(N.LINEAR,N.LINEAR_MIPMAP_LINEAR,N.CLAMP_TO_EDGE,N.CLAMP_TO_EDGE,"SheenCubeMapSampler"));const o=r++;i.samplers.push(new He(N.LINEAR,N.LINEAR,N.CLAMP_TO_EDGE,N.CLAMP_TO_EDGE,"LUTSampler"));const a=r++;let l=i.images.length,c=new st(t);c.init(e),c.filterAll();const u=new U(void 0,N.TEXTURE_CUBE_MAP,0,void 0,"Diffuse",C,c.lambertianTextureID);i.images.push(u);const f=new Me(s,[l++],N.TEXTURE_CUBE_MAP,c.lambertianTextureID);i.textures.push(f),i.diffuseEnvMap=new we(i.textures.length-1,0,!0),i.diffuseEnvMap.generateMips=!1;const h=new U(void 0,N.TEXTURE_CUBE_MAP,0,void 0,"Specular",C,c.ggxTextureID);i.images.push(h);const d=new Me(n,[l++],N.TEXTURE_CUBE_MAP,c.ggxTextureID);i.textures.push(d),i.specularEnvMap=new we(i.textures.length-1,0,!0),i.specularEnvMap.generateMips=!1;const m=new U(void 0,N.TEXTURE_CUBE_MAP,0,void 0,"Sheen",C,c.ggxTextureID);i.images.push(m);const p=new Me(o,[l++],N.TEXTURE_CUBE_MAP,c.sheenTextureID);return i.textures.push(p),i.sheenEnvMap=new we(i.textures.length-1,0,!0),i.sheenEnvMap.generateMips=!1,i.images.push(new U("assets/images/lut_ggx.png",N.TEXTURE_2D)),i.textures.push(new Me(a,[l++],N.TEXTURE_2D)),i.lut=new we(i.textures.length-1),i.lut.generateMips=!1,i.images.push(new U("assets/images/lut_charlie.png",N.TEXTURE_2D)),i.textures.push(new Me(a,[l++],N.TEXTURE_2D)),i.sheenLUT=new we(i.textures.length-1),i.sheenLUT.generateMips=!1,i.images.push(new U("assets/images/lut_sheen_E.png",N.TEXTURE_2D)),i.textures.push(new Me(a,[l++],N.TEXTURE_2D)),i.sheenELUT=new we(i.textures.length-1),i.sheenELUT.generateMips=!1,await rt.loadImages(i),i.initGl(t.context),i.mipCount=c.mipmapLevels,i}(i,t)},exports.loadGltf=async function(e,t,i){let r,s,n,o,a="";if("string"==typeof e){r=f(e);let t=await Ae.get(e,{responseType:r?"arraybuffer":"json"});n=t.data,o=t.data,a=e}else if(e instanceof ArrayBuffer)r=void 0===i,r&&(o=e);else if("undefined"!=typeof File&&e instanceof File){let t=e;a=e.name,r=f(a),r?o=await x.readAsArrayBuffer(t):(o=await x.readAsText(t),n=JSON.parse(o),s=i)}else console.error("Passed invalid type to loadGltf "+typeof e);if(r){const e=new it(o).extractGlbData();n=e.json,s=e.buffers}const l=new tt(a);l.ktxDecoder=t.ktxDecoder,l.fromJson(n);for(const e of l.images)e.resolveRelativePath(d(l.path));return await rt.load(l,t.context,s),l};
//# sourceMappingURL=gltf-sample-viewer.js.map
